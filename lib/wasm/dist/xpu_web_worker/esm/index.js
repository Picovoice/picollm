function I(g){return I="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(I){return typeof I}:function(I){return I&&"function"==typeof Symbol&&I.constructor===Symbol&&I!==Symbol.prototype?"symbol":typeof I},I(g)}function g(g){var C=function(g,C){if("object"!=I(g)||!g)return g;var A=g[Symbol.toPrimitive];if(void 0!==A){var e=A.call(g,C||"default");if("object"!=I(e))return e;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===C?String:Number)(g)}(g,"string");return"symbol"==I(C)?C:String(C)}function C(I,C,A){return(C=g(C))in I?Object.defineProperty(I,C,{value:A,enumerable:!0,configurable:!0,writable:!0}):I[C]=A,I}function A(I,g,C,A,e,c,i){try{var o=I[c](i),t=o.value}catch(I){return void C(I)}o.done?g(t):Promise.resolve(t).then(A,e)}function e(I){return function(){var g=this,C=arguments;return new Promise((function(e,c){var i=I.apply(g,C);function o(I){A(i,e,c,o,t,"next",I)}function t(I){A(i,e,c,o,t,"throw",I)}o(void 0)}))}}function c(I){return I&&I.__esModule&&Object.prototype.hasOwnProperty.call(I,"default")?I.default:I}var i={exports:{}},o={exports:{}};!function(I){function g(C){return I.exports=g="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(I){return typeof I}:function(I){return I&&"function"==typeof Symbol&&I.constructor===Symbol&&I!==Symbol.prototype?"symbol":typeof I},I.exports.__esModule=!0,I.exports.default=I.exports,g(C)}I.exports=g,I.exports.__esModule=!0,I.exports.default=I.exports}(o);var t=o.exports;!function(I){var g=t.default;function C(){I.exports=C=function(){return e},I.exports.__esModule=!0,I.exports.default=I.exports;var A,e={},c=Object.prototype,i=c.hasOwnProperty,o=Object.defineProperty||function(I,g,C){I[g]=C.value},t="function"==typeof Symbol?Symbol:{},l=t.iterator||"@@iterator",n=t.asyncIterator||"@@asyncIterator",b=t.toStringTag||"@@toStringTag";function r(I,g,C){return Object.defineProperty(I,g,{value:C,enumerable:!0,configurable:!0,writable:!0}),I[g]}try{r({},"")}catch(A){r=function(I,g,C){return I[g]=C}}function d(I,g,C,A){var e=g&&g.prototype instanceof y?g:y,c=Object.create(e.prototype),i=new k(A||[]);return o(c,"_invoke",{value:w(I,C,i)}),c}function Z(I,g,C){try{return{type:"normal",arg:I.call(g,C)}}catch(I){return{type:"throw",arg:I}}}e.wrap=d;var m="suspendedStart",u="suspendedYield",a="executing",s="completed",B={};function y(){}function G(){}function H(){}var h={};r(h,l,(function(){return this}));var V=Object.getPrototypeOf,X=V&&V(V(Y([])));X&&X!==c&&i.call(X,l)&&(h=X);var S=H.prototype=y.prototype=Object.create(h);function p(I){["next","throw","return"].forEach((function(g){r(I,g,(function(I){return this._invoke(g,I)}))}))}function W(I,C){function A(e,c,o,t){var l=Z(I[e],I,c);if("throw"!==l.type){var n=l.arg,b=n.value;return b&&"object"==g(b)&&i.call(b,"__await")?C.resolve(b.__await).then((function(I){A("next",I,o,t)}),(function(I){A("throw",I,o,t)})):C.resolve(b).then((function(I){n.value=I,o(n)}),(function(I){return A("throw",I,o,t)}))}t(l.arg)}var e;o(this,"_invoke",{value:function(I,g){function c(){return new C((function(C,e){A(I,g,C,e)}))}return e=e?e.then(c,c):c()}})}function w(I,g,C){var e=m;return function(c,i){if(e===a)throw new Error("Generator is already running");if(e===s){if("throw"===c)throw i;return{value:A,done:!0}}for(C.method=c,C.arg=i;;){var o=C.delegate;if(o){var t=J(o,C);if(t){if(t===B)continue;return t}}if("next"===C.method)C.sent=C._sent=C.arg;else if("throw"===C.method){if(e===m)throw e=s,C.arg;C.dispatchException(C.arg)}else"return"===C.method&&C.abrupt("return",C.arg);e=a;var l=Z(I,g,C);if("normal"===l.type){if(e=C.done?s:u,l.arg===B)continue;return{value:l.arg,done:C.done}}"throw"===l.type&&(e=s,C.method="throw",C.arg=l.arg)}}}function J(I,g){var C=g.method,e=I.iterator[C];if(e===A)return g.delegate=null,"throw"===C&&I.iterator.return&&(g.method="return",g.arg=A,J(I,g),"throw"===g.method)||"return"!==C&&(g.method="throw",g.arg=new TypeError("The iterator does not provide a '"+C+"' method")),B;var c=Z(e,I.iterator,g.arg);if("throw"===c.type)return g.method="throw",g.arg=c.arg,g.delegate=null,B;var i=c.arg;return i?i.done?(g[I.resultName]=i.value,g.next=I.nextLoc,"return"!==g.method&&(g.method="next",g.arg=A),g.delegate=null,B):i:(g.method="throw",g.arg=new TypeError("iterator result is not an object"),g.delegate=null,B)}function R(I){var g={tryLoc:I[0]};1 in I&&(g.catchLoc=I[1]),2 in I&&(g.finallyLoc=I[2],g.afterLoc=I[3]),this.tryEntries.push(g)}function K(I){var g=I.completion||{};g.type="normal",delete g.arg,I.completion=g}function k(I){this.tryEntries=[{tryLoc:"root"}],I.forEach(R,this),this.reset(!0)}function Y(I){if(I||""===I){var C=I[l];if(C)return C.call(I);if("function"==typeof I.next)return I;if(!isNaN(I.length)){var e=-1,c=function g(){for(;++e<I.length;)if(i.call(I,e))return g.value=I[e],g.done=!1,g;return g.value=A,g.done=!0,g};return c.next=c}}throw new TypeError(g(I)+" is not iterable")}return G.prototype=H,o(S,"constructor",{value:H,configurable:!0}),o(H,"constructor",{value:G,configurable:!0}),G.displayName=r(H,b,"GeneratorFunction"),e.isGeneratorFunction=function(I){var g="function"==typeof I&&I.constructor;return!!g&&(g===G||"GeneratorFunction"===(g.displayName||g.name))},e.mark=function(I){return Object.setPrototypeOf?Object.setPrototypeOf(I,H):(I.__proto__=H,r(I,b,"GeneratorFunction")),I.prototype=Object.create(S),I},e.awrap=function(I){return{__await:I}},p(W.prototype),r(W.prototype,n,(function(){return this})),e.AsyncIterator=W,e.async=function(I,g,C,A,c){void 0===c&&(c=Promise);var i=new W(d(I,g,C,A),c);return e.isGeneratorFunction(g)?i:i.next().then((function(I){return I.done?I.value:i.next()}))},p(S),r(S,b,"Generator"),r(S,l,(function(){return this})),r(S,"toString",(function(){return"[object Generator]"})),e.keys=function(I){var g=Object(I),C=[];for(var A in g)C.push(A);return C.reverse(),function I(){for(;C.length;){var A=C.pop();if(A in g)return I.value=A,I.done=!1,I}return I.done=!0,I}},e.values=Y,k.prototype={constructor:k,reset:function(I){if(this.prev=0,this.next=0,this.sent=this._sent=A,this.done=!1,this.delegate=null,this.method="next",this.arg=A,this.tryEntries.forEach(K),!I)for(var g in this)"t"===g.charAt(0)&&i.call(this,g)&&!isNaN(+g.slice(1))&&(this[g]=A)},stop:function(){this.done=!0;var I=this.tryEntries[0].completion;if("throw"===I.type)throw I.arg;return this.rval},dispatchException:function(I){if(this.done)throw I;var g=this;function C(C,e){return o.type="throw",o.arg=I,g.next=C,e&&(g.method="next",g.arg=A),!!e}for(var e=this.tryEntries.length-1;e>=0;--e){var c=this.tryEntries[e],o=c.completion;if("root"===c.tryLoc)return C("end");if(c.tryLoc<=this.prev){var t=i.call(c,"catchLoc"),l=i.call(c,"finallyLoc");if(t&&l){if(this.prev<c.catchLoc)return C(c.catchLoc,!0);if(this.prev<c.finallyLoc)return C(c.finallyLoc)}else if(t){if(this.prev<c.catchLoc)return C(c.catchLoc,!0)}else{if(!l)throw new Error("try statement without catch or finally");if(this.prev<c.finallyLoc)return C(c.finallyLoc)}}}},abrupt:function(I,g){for(var C=this.tryEntries.length-1;C>=0;--C){var A=this.tryEntries[C];if(A.tryLoc<=this.prev&&i.call(A,"finallyLoc")&&this.prev<A.finallyLoc){var e=A;break}}e&&("break"===I||"continue"===I)&&e.tryLoc<=g&&g<=e.finallyLoc&&(e=null);var c=e?e.completion:{};return c.type=I,c.arg=g,e?(this.method="next",this.next=e.finallyLoc,B):this.complete(c)},complete:function(I,g){if("throw"===I.type)throw I.arg;return"break"===I.type||"continue"===I.type?this.next=I.arg:"return"===I.type?(this.rval=this.arg=I.arg,this.method="return",this.next="end"):"normal"===I.type&&g&&(this.next=g),B},finish:function(I){for(var g=this.tryEntries.length-1;g>=0;--g){var C=this.tryEntries[g];if(C.finallyLoc===I)return this.complete(C.completion,C.afterLoc),K(C),B}},catch:function(I){for(var g=this.tryEntries.length-1;g>=0;--g){var C=this.tryEntries[g];if(C.tryLoc===I){var A=C.completion;if("throw"===A.type){var e=A.arg;K(C)}return e}}throw new Error("illegal catch attempt")},delegateYield:function(I,g,C){return this.delegate={iterator:Y(I),resultName:g,nextLoc:C},"next"===this.method&&(this.arg=A),B}},e}I.exports=C,I.exports.__esModule=!0,I.exports.default=I.exports}(i);var l=(0,i.exports)(),n=l;try{regeneratorRuntime=l}catch(I){"object"==typeof globalThis?globalThis.regeneratorRuntime=l:Function("r","regeneratorRuntime = r")(l)}var b=c(n);function r(I,g,C){var A=void 0===g?null:g,e=function(I,g){var C=atob(I);if(g){for(var A=new Uint8Array(C.length),e=0,c=C.length;e<c;++e)A[e]=C.charCodeAt(e);return String.fromCharCode.apply(null,new Uint16Array(A.buffer))}return C}(I,void 0!==C&&C),c=e.indexOf("\n",10)+1,i=e.substring(c)+(A?"//# sourceMappingURL="+A:""),o=new Blob([i],{type:"application/javascript"});return URL.createObjectURL(o)}var d,Z,m,u,a,s=(d="Lyogcm9sbHVwLXBsdWdpbi13ZWItd29ya2VyLWxvYWRlciAqLwooZnVuY3Rpb24gKCkgewogICd1c2Ugc3RyaWN0JzsKCiAgZnVuY3Rpb24gX3R5cGVvZiQxKG8pIHsKICAgICJAYmFiZWwvaGVscGVycyAtIHR5cGVvZiI7CgogICAgcmV0dXJuIF90eXBlb2YkMSA9ICJmdW5jdGlvbiIgPT0gdHlwZW9mIFN5bWJvbCAmJiAic3ltYm9sIiA9PSB0eXBlb2YgU3ltYm9sLml0ZXJhdG9yID8gZnVuY3Rpb24gKG8pIHsKICAgICAgcmV0dXJuIHR5cGVvZiBvOwogICAgfSA6IGZ1bmN0aW9uIChvKSB7CiAgICAgIHJldHVybiBvICYmICJmdW5jdGlvbiIgPT0gdHlwZW9mIFN5bWJvbCAmJiBvLmNvbnN0cnVjdG9yID09PSBTeW1ib2wgJiYgbyAhPT0gU3ltYm9sLnByb3RvdHlwZSA/ICJzeW1ib2wiIDogdHlwZW9mIG87CiAgICB9LCBfdHlwZW9mJDEobyk7CiAgfQoKICBmdW5jdGlvbiB0b1ByaW1pdGl2ZSh0LCByKSB7CiAgICBpZiAoIm9iamVjdCIgIT0gX3R5cGVvZiQxKHQpIHx8ICF0KSByZXR1cm4gdDsKICAgIHZhciBlID0gdFtTeW1ib2wudG9QcmltaXRpdmVdOwogICAgaWYgKHZvaWQgMCAhPT0gZSkgewogICAgICB2YXIgaSA9IGUuY2FsbCh0LCByIHx8ICJkZWZhdWx0Iik7CiAgICAgIGlmICgib2JqZWN0IiAhPSBfdHlwZW9mJDEoaSkpIHJldHVybiBpOwogICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJAQHRvUHJpbWl0aXZlIG11c3QgcmV0dXJuIGEgcHJpbWl0aXZlIHZhbHVlLiIpOwogICAgfQogICAgcmV0dXJuICgic3RyaW5nIiA9PT0gciA/IFN0cmluZyA6IE51bWJlcikodCk7CiAgfQoKICBmdW5jdGlvbiB0b1Byb3BlcnR5S2V5KHQpIHsKICAgIHZhciBpID0gdG9QcmltaXRpdmUodCwgInN0cmluZyIpOwogICAgcmV0dXJuICJzeW1ib2wiID09IF90eXBlb2YkMShpKSA/IGkgOiBTdHJpbmcoaSk7CiAgfQoKICBmdW5jdGlvbiBfZGVmaW5lUHJvcGVydHkob2JqLCBrZXksIHZhbHVlKSB7CiAgICBrZXkgPSB0b1Byb3BlcnR5S2V5KGtleSk7CiAgICBpZiAoa2V5IGluIG9iaikgewogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkob2JqLCBrZXksIHsKICAgICAgICB2YWx1ZTogdmFsdWUsCiAgICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICAgICAgd3JpdGFibGU6IHRydWUKICAgICAgfSk7CiAgICB9IGVsc2UgewogICAgICBvYmpba2V5XSA9IHZhbHVlOwogICAgfQogICAgcmV0dXJuIG9iajsKICB9CgogIGZ1bmN0aW9uIGFzeW5jR2VuZXJhdG9yU3RlcChnZW4sIHJlc29sdmUsIHJlamVjdCwgX25leHQsIF90aHJvdywga2V5LCBhcmcpIHsKICAgIHRyeSB7CiAgICAgIHZhciBpbmZvID0gZ2VuW2tleV0oYXJnKTsKICAgICAgdmFyIHZhbHVlID0gaW5mby52YWx1ZTsKICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgIHJlamVjdChlcnJvcik7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmIChpbmZvLmRvbmUpIHsKICAgICAgcmVzb2x2ZSh2YWx1ZSk7CiAgICB9IGVsc2UgewogICAgICBQcm9taXNlLnJlc29sdmUodmFsdWUpLnRoZW4oX25leHQsIF90aHJvdyk7CiAgICB9CiAgfQogIGZ1bmN0aW9uIF9hc3luY1RvR2VuZXJhdG9yKGZuKSB7CiAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICB2YXIgc2VsZiA9IHRoaXMsCiAgICAgICAgYXJncyA9IGFyZ3VtZW50czsKICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKICAgICAgICB2YXIgZ2VuID0gZm4uYXBwbHkoc2VsZiwgYXJncyk7CiAgICAgICAgZnVuY3Rpb24gX25leHQodmFsdWUpIHsKICAgICAgICAgIGFzeW5jR2VuZXJhdG9yU3RlcChnZW4sIHJlc29sdmUsIHJlamVjdCwgX25leHQsIF90aHJvdywgIm5leHQiLCB2YWx1ZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIF90aHJvdyhlcnIpIHsKICAgICAgICAgIGFzeW5jR2VuZXJhdG9yU3RlcChnZW4sIHJlc29sdmUsIHJlamVjdCwgX25leHQsIF90aHJvdywgInRocm93IiwgZXJyKTsKICAgICAgICB9CiAgICAgICAgX25leHQodW5kZWZpbmVkKTsKICAgICAgfSk7CiAgICB9OwogIH0KCiAgZnVuY3Rpb24gZ2V0RGVmYXVsdEV4cG9ydEZyb21DanMgKHgpIHsKICAJcmV0dXJuIHggJiYgeC5fX2VzTW9kdWxlICYmIE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbCh4LCAnZGVmYXVsdCcpID8geFsnZGVmYXVsdCddIDogeDsKICB9CgogIHZhciByZWdlbmVyYXRvclJ1bnRpbWUkMSA9IHtleHBvcnRzOiB7fX07CgogIHZhciBfdHlwZW9mID0ge2V4cG9ydHM6IHt9fTsKCiAgX3R5cGVvZi5leHBvcnRzOwoKICAoZnVuY3Rpb24gKG1vZHVsZSkgewogIAlmdW5jdGlvbiBfdHlwZW9mKG8pIHsKICAJICAiQGJhYmVsL2hlbHBlcnMgLSB0eXBlb2YiOwoKICAJICByZXR1cm4gKG1vZHVsZS5leHBvcnRzID0gX3R5cGVvZiA9ICJmdW5jdGlvbiIgPT0gdHlwZW9mIFN5bWJvbCAmJiAic3ltYm9sIiA9PSB0eXBlb2YgU3ltYm9sLml0ZXJhdG9yID8gZnVuY3Rpb24gKG8pIHsKICAJICAgIHJldHVybiB0eXBlb2YgbzsKICAJICB9IDogZnVuY3Rpb24gKG8pIHsKICAJICAgIHJldHVybiBvICYmICJmdW5jdGlvbiIgPT0gdHlwZW9mIFN5bWJvbCAmJiBvLmNvbnN0cnVjdG9yID09PSBTeW1ib2wgJiYgbyAhPT0gU3ltYm9sLnByb3RvdHlwZSA/ICJzeW1ib2wiIDogdHlwZW9mIG87CiAgCSAgfSwgbW9kdWxlLmV4cG9ydHMuX19lc01vZHVsZSA9IHRydWUsIG1vZHVsZS5leHBvcnRzWyJkZWZhdWx0Il0gPSBtb2R1bGUuZXhwb3J0cyksIF90eXBlb2Yobyk7CiAgCX0KICAJbW9kdWxlLmV4cG9ydHMgPSBfdHlwZW9mLCBtb2R1bGUuZXhwb3J0cy5fX2VzTW9kdWxlID0gdHJ1ZSwgbW9kdWxlLmV4cG9ydHNbImRlZmF1bHQiXSA9IG1vZHVsZS5leHBvcnRzOyAKICB9IChfdHlwZW9mKSk7CgogIHZhciBfdHlwZW9mRXhwb3J0cyA9IF90eXBlb2YuZXhwb3J0czsKCiAgcmVnZW5lcmF0b3JSdW50aW1lJDEuZXhwb3J0czsKCiAgKGZ1bmN0aW9uIChtb2R1bGUpIHsKICAJdmFyIF90eXBlb2YgPSBfdHlwZW9mRXhwb3J0c1siZGVmYXVsdCJdOwogIAlmdW5jdGlvbiBfcmVnZW5lcmF0b3JSdW50aW1lKCkgewogIAkgIG1vZHVsZS5leHBvcnRzID0gX3JlZ2VuZXJhdG9yUnVudGltZSA9IGZ1bmN0aW9uIF9yZWdlbmVyYXRvclJ1bnRpbWUoKSB7CiAgCSAgICByZXR1cm4gZTsKICAJICB9LCBtb2R1bGUuZXhwb3J0cy5fX2VzTW9kdWxlID0gdHJ1ZSwgbW9kdWxlLmV4cG9ydHNbImRlZmF1bHQiXSA9IG1vZHVsZS5leHBvcnRzOwogIAkgIHZhciB0LAogIAkgICAgZSA9IHt9LAogIAkgICAgciA9IE9iamVjdC5wcm90b3R5cGUsCiAgCSAgICBuID0gci5oYXNPd25Qcm9wZXJ0eSwKICAJICAgIG8gPSBPYmplY3QuZGVmaW5lUHJvcGVydHkgfHwgZnVuY3Rpb24gKHQsIGUsIHIpIHsKICAJICAgICAgdFtlXSA9IHIudmFsdWU7CiAgCSAgICB9LAogIAkgICAgaSA9ICJmdW5jdGlvbiIgPT0gdHlwZW9mIFN5bWJvbCA/IFN5bWJvbCA6IHt9LAogIAkgICAgYSA9IGkuaXRlcmF0b3IgfHwgIkBAaXRlcmF0b3IiLAogIAkgICAgYyA9IGkuYXN5bmNJdGVyYXRvciB8fCAiQEBhc3luY0l0ZXJhdG9yIiwKICAJICAgIHUgPSBpLnRvU3RyaW5nVGFnIHx8ICJAQHRvU3RyaW5nVGFnIjsKICAJICBmdW5jdGlvbiBkZWZpbmUodCwgZSwgcikgewogIAkgICAgcmV0dXJuIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0LCBlLCB7CiAgCSAgICAgIHZhbHVlOiByLAogIAkgICAgICBlbnVtZXJhYmxlOiAhMCwKICAJICAgICAgY29uZmlndXJhYmxlOiAhMCwKICAJICAgICAgd3JpdGFibGU6ICEwCiAgCSAgICB9KSwgdFtlXTsKICAJICB9CiAgCSAgdHJ5IHsKICAJICAgIGRlZmluZSh7fSwgIiIpOwogIAkgIH0gY2F0Y2ggKHQpIHsKICAJICAgIGRlZmluZSA9IGZ1bmN0aW9uIGRlZmluZSh0LCBlLCByKSB7CiAgCSAgICAgIHJldHVybiB0W2VdID0gcjsKICAJICAgIH07CiAgCSAgfQogIAkgIGZ1bmN0aW9uIHdyYXAodCwgZSwgciwgbikgewogIAkgICAgdmFyIGkgPSBlICYmIGUucHJvdG90eXBlIGluc3RhbmNlb2YgR2VuZXJhdG9yID8gZSA6IEdlbmVyYXRvciwKICAJICAgICAgYSA9IE9iamVjdC5jcmVhdGUoaS5wcm90b3R5cGUpLAogIAkgICAgICBjID0gbmV3IENvbnRleHQobiB8fCBbXSk7CiAgCSAgICByZXR1cm4gbyhhLCAiX2ludm9rZSIsIHsKICAJICAgICAgdmFsdWU6IG1ha2VJbnZva2VNZXRob2QodCwgciwgYykKICAJICAgIH0pLCBhOwogIAkgIH0KICAJICBmdW5jdGlvbiB0cnlDYXRjaCh0LCBlLCByKSB7CiAgCSAgICB0cnkgewogIAkgICAgICByZXR1cm4gewogIAkgICAgICAgIHR5cGU6ICJub3JtYWwiLAogIAkgICAgICAgIGFyZzogdC5jYWxsKGUsIHIpCiAgCSAgICAgIH07CiAgCSAgICB9IGNhdGNoICh0KSB7CiAgCSAgICAgIHJldHVybiB7CiAgCSAgICAgICAgdHlwZTogInRocm93IiwKICAJICAgICAgICBhcmc6IHQKICAJICAgICAgfTsKICAJICAgIH0KICAJICB9CiAgCSAgZS53cmFwID0gd3JhcDsKICAJICB2YXIgaCA9ICJzdXNwZW5kZWRTdGFydCIsCiAgCSAgICBsID0gInN1c3BlbmRlZFlpZWxkIiwKICAJICAgIGYgPSAiZXhlY3V0aW5nIiwKICAJICAgIHMgPSAiY29tcGxldGVkIiwKICAJICAgIHkgPSB7fTsKICAJICBmdW5jdGlvbiBHZW5lcmF0b3IoKSB7fQogIAkgIGZ1bmN0aW9uIEdlbmVyYXRvckZ1bmN0aW9uKCkge30KICAJICBmdW5jdGlvbiBHZW5lcmF0b3JGdW5jdGlvblByb3RvdHlwZSgpIHt9CiAgCSAgdmFyIHAgPSB7fTsKICAJICBkZWZpbmUocCwgYSwgZnVuY3Rpb24gKCkgewogIAkgICAgcmV0dXJuIHRoaXM7CiAgCSAgfSk7CiAgCSAgdmFyIGQgPSBPYmplY3QuZ2V0UHJvdG90eXBlT2YsCiAgCSAgICB2ID0gZCAmJiBkKGQodmFsdWVzKFtdKSkpOwogIAkgIHYgJiYgdiAhPT0gciAmJiBuLmNhbGwodiwgYSkgJiYgKHAgPSB2KTsKICAJICB2YXIgZyA9IEdlbmVyYXRvckZ1bmN0aW9uUHJvdG90eXBlLnByb3RvdHlwZSA9IEdlbmVyYXRvci5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKHApOwogIAkgIGZ1bmN0aW9uIGRlZmluZUl0ZXJhdG9yTWV0aG9kcyh0KSB7CiAgCSAgICBbIm5leHQiLCAidGhyb3ciLCAicmV0dXJuIl0uZm9yRWFjaChmdW5jdGlvbiAoZSkgewogIAkgICAgICBkZWZpbmUodCwgZSwgZnVuY3Rpb24gKHQpIHsKICAJICAgICAgICByZXR1cm4gdGhpcy5faW52b2tlKGUsIHQpOwogIAkgICAgICB9KTsKICAJICAgIH0pOwogIAkgIH0KICAJICBmdW5jdGlvbiBBc3luY0l0ZXJhdG9yKHQsIGUpIHsKICAJICAgIGZ1bmN0aW9uIGludm9rZShyLCBvLCBpLCBhKSB7CiAgCSAgICAgIHZhciBjID0gdHJ5Q2F0Y2godFtyXSwgdCwgbyk7CiAgCSAgICAgIGlmICgidGhyb3ciICE9PSBjLnR5cGUpIHsKICAJICAgICAgICB2YXIgdSA9IGMuYXJnLAogIAkgICAgICAgICAgaCA9IHUudmFsdWU7CiAgCSAgICAgICAgcmV0dXJuIGggJiYgIm9iamVjdCIgPT0gX3R5cGVvZihoKSAmJiBuLmNhbGwoaCwgIl9fYXdhaXQiKSA/IGUucmVzb2x2ZShoLl9fYXdhaXQpLnRoZW4oZnVuY3Rpb24gKHQpIHsKICAJICAgICAgICAgIGludm9rZSgibmV4dCIsIHQsIGksIGEpOwogIAkgICAgICAgIH0sIGZ1bmN0aW9uICh0KSB7CiAgCSAgICAgICAgICBpbnZva2UoInRocm93IiwgdCwgaSwgYSk7CiAgCSAgICAgICAgfSkgOiBlLnJlc29sdmUoaCkudGhlbihmdW5jdGlvbiAodCkgewogIAkgICAgICAgICAgdS52YWx1ZSA9IHQsIGkodSk7CiAgCSAgICAgICAgfSwgZnVuY3Rpb24gKHQpIHsKICAJICAgICAgICAgIHJldHVybiBpbnZva2UoInRocm93IiwgdCwgaSwgYSk7CiAgCSAgICAgICAgfSk7CiAgCSAgICAgIH0KICAJICAgICAgYShjLmFyZyk7CiAgCSAgICB9CiAgCSAgICB2YXIgcjsKICAJICAgIG8odGhpcywgIl9pbnZva2UiLCB7CiAgCSAgICAgIHZhbHVlOiBmdW5jdGlvbiB2YWx1ZSh0LCBuKSB7CiAgCSAgICAgICAgZnVuY3Rpb24gY2FsbEludm9rZVdpdGhNZXRob2RBbmRBcmcoKSB7CiAgCSAgICAgICAgICByZXR1cm4gbmV3IGUoZnVuY3Rpb24gKGUsIHIpIHsKICAJICAgICAgICAgICAgaW52b2tlKHQsIG4sIGUsIHIpOwogIAkgICAgICAgICAgfSk7CiAgCSAgICAgICAgfQogIAkgICAgICAgIHJldHVybiByID0gciA/IHIudGhlbihjYWxsSW52b2tlV2l0aE1ldGhvZEFuZEFyZywgY2FsbEludm9rZVdpdGhNZXRob2RBbmRBcmcpIDogY2FsbEludm9rZVdpdGhNZXRob2RBbmRBcmcoKTsKICAJICAgICAgfQogIAkgICAgfSk7CiAgCSAgfQogIAkgIGZ1bmN0aW9uIG1ha2VJbnZva2VNZXRob2QoZSwgciwgbikgewogIAkgICAgdmFyIG8gPSBoOwogIAkgICAgcmV0dXJuIGZ1bmN0aW9uIChpLCBhKSB7CiAgCSAgICAgIGlmIChvID09PSBmKSB0aHJvdyBuZXcgRXJyb3IoIkdlbmVyYXRvciBpcyBhbHJlYWR5IHJ1bm5pbmciKTsKICAJICAgICAgaWYgKG8gPT09IHMpIHsKICAJICAgICAgICBpZiAoInRocm93IiA9PT0gaSkgdGhyb3cgYTsKICAJICAgICAgICByZXR1cm4gewogIAkgICAgICAgICAgdmFsdWU6IHQsCiAgCSAgICAgICAgICBkb25lOiAhMAogIAkgICAgICAgIH07CiAgCSAgICAgIH0KICAJICAgICAgZm9yIChuLm1ldGhvZCA9IGksIG4uYXJnID0gYTs7KSB7CiAgCSAgICAgICAgdmFyIGMgPSBuLmRlbGVnYXRlOwogIAkgICAgICAgIGlmIChjKSB7CiAgCSAgICAgICAgICB2YXIgdSA9IG1heWJlSW52b2tlRGVsZWdhdGUoYywgbik7CiAgCSAgICAgICAgICBpZiAodSkgewogIAkgICAgICAgICAgICBpZiAodSA9PT0geSkgY29udGludWU7CiAgCSAgICAgICAgICAgIHJldHVybiB1OwogIAkgICAgICAgICAgfQogIAkgICAgICAgIH0KICAJICAgICAgICBpZiAoIm5leHQiID09PSBuLm1ldGhvZCkgbi5zZW50ID0gbi5fc2VudCA9IG4uYXJnO2Vsc2UgaWYgKCJ0aHJvdyIgPT09IG4ubWV0aG9kKSB7CiAgCSAgICAgICAgICBpZiAobyA9PT0gaCkgdGhyb3cgbyA9IHMsIG4uYXJnOwogIAkgICAgICAgICAgbi5kaXNwYXRjaEV4Y2VwdGlvbihuLmFyZyk7CiAgCSAgICAgICAgfSBlbHNlICJyZXR1cm4iID09PSBuLm1ldGhvZCAmJiBuLmFicnVwdCgicmV0dXJuIiwgbi5hcmcpOwogIAkgICAgICAgIG8gPSBmOwogIAkgICAgICAgIHZhciBwID0gdHJ5Q2F0Y2goZSwgciwgbik7CiAgCSAgICAgICAgaWYgKCJub3JtYWwiID09PSBwLnR5cGUpIHsKICAJICAgICAgICAgIGlmIChvID0gbi5kb25lID8gcyA6IGwsIHAuYXJnID09PSB5KSBjb250aW51ZTsKICAJICAgICAgICAgIHJldHVybiB7CiAgCSAgICAgICAgICAgIHZhbHVlOiBwLmFyZywKICAJICAgICAgICAgICAgZG9uZTogbi5kb25lCiAgCSAgICAgICAgICB9OwogIAkgICAgICAgIH0KICAJICAgICAgICAidGhyb3ciID09PSBwLnR5cGUgJiYgKG8gPSBzLCBuLm1ldGhvZCA9ICJ0aHJvdyIsIG4uYXJnID0gcC5hcmcpOwogIAkgICAgICB9CiAgCSAgICB9OwogIAkgIH0KICAJICBmdW5jdGlvbiBtYXliZUludm9rZURlbGVnYXRlKGUsIHIpIHsKICAJICAgIHZhciBuID0gci5tZXRob2QsCiAgCSAgICAgIG8gPSBlLml0ZXJhdG9yW25dOwogIAkgICAgaWYgKG8gPT09IHQpIHJldHVybiByLmRlbGVnYXRlID0gbnVsbCwgInRocm93IiA9PT0gbiAmJiBlLml0ZXJhdG9yWyJyZXR1cm4iXSAmJiAoci5tZXRob2QgPSAicmV0dXJuIiwgci5hcmcgPSB0LCBtYXliZUludm9rZURlbGVnYXRlKGUsIHIpLCAidGhyb3ciID09PSByLm1ldGhvZCkgfHwgInJldHVybiIgIT09IG4gJiYgKHIubWV0aG9kID0gInRocm93Iiwgci5hcmcgPSBuZXcgVHlwZUVycm9yKCJUaGUgaXRlcmF0b3IgZG9lcyBub3QgcHJvdmlkZSBhICciICsgbiArICInIG1ldGhvZCIpKSwgeTsKICAJICAgIHZhciBpID0gdHJ5Q2F0Y2gobywgZS5pdGVyYXRvciwgci5hcmcpOwogIAkgICAgaWYgKCJ0aHJvdyIgPT09IGkudHlwZSkgcmV0dXJuIHIubWV0aG9kID0gInRocm93Iiwgci5hcmcgPSBpLmFyZywgci5kZWxlZ2F0ZSA9IG51bGwsIHk7CiAgCSAgICB2YXIgYSA9IGkuYXJnOwogIAkgICAgcmV0dXJuIGEgPyBhLmRvbmUgPyAocltlLnJlc3VsdE5hbWVdID0gYS52YWx1ZSwgci5uZXh0ID0gZS5uZXh0TG9jLCAicmV0dXJuIiAhPT0gci5tZXRob2QgJiYgKHIubWV0aG9kID0gIm5leHQiLCByLmFyZyA9IHQpLCByLmRlbGVnYXRlID0gbnVsbCwgeSkgOiBhIDogKHIubWV0aG9kID0gInRocm93Iiwgci5hcmcgPSBuZXcgVHlwZUVycm9yKCJpdGVyYXRvciByZXN1bHQgaXMgbm90IGFuIG9iamVjdCIpLCByLmRlbGVnYXRlID0gbnVsbCwgeSk7CiAgCSAgfQogIAkgIGZ1bmN0aW9uIHB1c2hUcnlFbnRyeSh0KSB7CiAgCSAgICB2YXIgZSA9IHsKICAJICAgICAgdHJ5TG9jOiB0WzBdCiAgCSAgICB9OwogIAkgICAgMSBpbiB0ICYmIChlLmNhdGNoTG9jID0gdFsxXSksIDIgaW4gdCAmJiAoZS5maW5hbGx5TG9jID0gdFsyXSwgZS5hZnRlckxvYyA9IHRbM10pLCB0aGlzLnRyeUVudHJpZXMucHVzaChlKTsKICAJICB9CiAgCSAgZnVuY3Rpb24gcmVzZXRUcnlFbnRyeSh0KSB7CiAgCSAgICB2YXIgZSA9IHQuY29tcGxldGlvbiB8fCB7fTsKICAJICAgIGUudHlwZSA9ICJub3JtYWwiLCBkZWxldGUgZS5hcmcsIHQuY29tcGxldGlvbiA9IGU7CiAgCSAgfQogIAkgIGZ1bmN0aW9uIENvbnRleHQodCkgewogIAkgICAgdGhpcy50cnlFbnRyaWVzID0gW3sKICAJICAgICAgdHJ5TG9jOiAicm9vdCIKICAJICAgIH1dLCB0LmZvckVhY2gocHVzaFRyeUVudHJ5LCB0aGlzKSwgdGhpcy5yZXNldCghMCk7CiAgCSAgfQogIAkgIGZ1bmN0aW9uIHZhbHVlcyhlKSB7CiAgCSAgICBpZiAoZSB8fCAiIiA9PT0gZSkgewogIAkgICAgICB2YXIgciA9IGVbYV07CiAgCSAgICAgIGlmIChyKSByZXR1cm4gci5jYWxsKGUpOwogIAkgICAgICBpZiAoImZ1bmN0aW9uIiA9PSB0eXBlb2YgZS5uZXh0KSByZXR1cm4gZTsKICAJICAgICAgaWYgKCFpc05hTihlLmxlbmd0aCkpIHsKICAJICAgICAgICB2YXIgbyA9IC0xLAogIAkgICAgICAgICAgaSA9IGZ1bmN0aW9uIG5leHQoKSB7CiAgCSAgICAgICAgICAgIGZvciAoOyArK28gPCBlLmxlbmd0aDspIGlmIChuLmNhbGwoZSwgbykpIHJldHVybiBuZXh0LnZhbHVlID0gZVtvXSwgbmV4dC5kb25lID0gITEsIG5leHQ7CiAgCSAgICAgICAgICAgIHJldHVybiBuZXh0LnZhbHVlID0gdCwgbmV4dC5kb25lID0gITAsIG5leHQ7CiAgCSAgICAgICAgICB9OwogIAkgICAgICAgIHJldHVybiBpLm5leHQgPSBpOwogIAkgICAgICB9CiAgCSAgICB9CiAgCSAgICB0aHJvdyBuZXcgVHlwZUVycm9yKF90eXBlb2YoZSkgKyAiIGlzIG5vdCBpdGVyYWJsZSIpOwogIAkgIH0KICAJICByZXR1cm4gR2VuZXJhdG9yRnVuY3Rpb24ucHJvdG90eXBlID0gR2VuZXJhdG9yRnVuY3Rpb25Qcm90b3R5cGUsIG8oZywgImNvbnN0cnVjdG9yIiwgewogIAkgICAgdmFsdWU6IEdlbmVyYXRvckZ1bmN0aW9uUHJvdG90eXBlLAogIAkgICAgY29uZmlndXJhYmxlOiAhMAogIAkgIH0pLCBvKEdlbmVyYXRvckZ1bmN0aW9uUHJvdG90eXBlLCAiY29uc3RydWN0b3IiLCB7CiAgCSAgICB2YWx1ZTogR2VuZXJhdG9yRnVuY3Rpb24sCiAgCSAgICBjb25maWd1cmFibGU6ICEwCiAgCSAgfSksIEdlbmVyYXRvckZ1bmN0aW9uLmRpc3BsYXlOYW1lID0gZGVmaW5lKEdlbmVyYXRvckZ1bmN0aW9uUHJvdG90eXBlLCB1LCAiR2VuZXJhdG9yRnVuY3Rpb24iKSwgZS5pc0dlbmVyYXRvckZ1bmN0aW9uID0gZnVuY3Rpb24gKHQpIHsKICAJICAgIHZhciBlID0gImZ1bmN0aW9uIiA9PSB0eXBlb2YgdCAmJiB0LmNvbnN0cnVjdG9yOwogIAkgICAgcmV0dXJuICEhZSAmJiAoZSA9PT0gR2VuZXJhdG9yRnVuY3Rpb24gfHwgIkdlbmVyYXRvckZ1bmN0aW9uIiA9PT0gKGUuZGlzcGxheU5hbWUgfHwgZS5uYW1lKSk7CiAgCSAgfSwgZS5tYXJrID0gZnVuY3Rpb24gKHQpIHsKICAJICAgIHJldHVybiBPYmplY3Quc2V0UHJvdG90eXBlT2YgPyBPYmplY3Quc2V0UHJvdG90eXBlT2YodCwgR2VuZXJhdG9yRnVuY3Rpb25Qcm90b3R5cGUpIDogKHQuX19wcm90b19fID0gR2VuZXJhdG9yRnVuY3Rpb25Qcm90b3R5cGUsIGRlZmluZSh0LCB1LCAiR2VuZXJhdG9yRnVuY3Rpb24iKSksIHQucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShnKSwgdDsKICAJICB9LCBlLmF3cmFwID0gZnVuY3Rpb24gKHQpIHsKICAJICAgIHJldHVybiB7CiAgCSAgICAgIF9fYXdhaXQ6IHQKICAJICAgIH07CiAgCSAgfSwgZGVmaW5lSXRlcmF0b3JNZXRob2RzKEFzeW5jSXRlcmF0b3IucHJvdG90eXBlKSwgZGVmaW5lKEFzeW5jSXRlcmF0b3IucHJvdG90eXBlLCBjLCBmdW5jdGlvbiAoKSB7CiAgCSAgICByZXR1cm4gdGhpczsKICAJICB9KSwgZS5Bc3luY0l0ZXJhdG9yID0gQXN5bmNJdGVyYXRvciwgZS5hc3luYyA9IGZ1bmN0aW9uICh0LCByLCBuLCBvLCBpKSB7CiAgCSAgICB2b2lkIDAgPT09IGkgJiYgKGkgPSBQcm9taXNlKTsKICAJICAgIHZhciBhID0gbmV3IEFzeW5jSXRlcmF0b3Iod3JhcCh0LCByLCBuLCBvKSwgaSk7CiAgCSAgICByZXR1cm4gZS5pc0dlbmVyYXRvckZ1bmN0aW9uKHIpID8gYSA6IGEubmV4dCgpLnRoZW4oZnVuY3Rpb24gKHQpIHsKICAJICAgICAgcmV0dXJuIHQuZG9uZSA/IHQudmFsdWUgOiBhLm5leHQoKTsKICAJICAgIH0pOwogIAkgIH0sIGRlZmluZUl0ZXJhdG9yTWV0aG9kcyhnKSwgZGVmaW5lKGcsIHUsICJHZW5lcmF0b3IiKSwgZGVmaW5lKGcsIGEsIGZ1bmN0aW9uICgpIHsKICAJICAgIHJldHVybiB0aGlzOwogIAkgIH0pLCBkZWZpbmUoZywgInRvU3RyaW5nIiwgZnVuY3Rpb24gKCkgewogIAkgICAgcmV0dXJuICJbb2JqZWN0IEdlbmVyYXRvcl0iOwogIAkgIH0pLCBlLmtleXMgPSBmdW5jdGlvbiAodCkgewogIAkgICAgdmFyIGUgPSBPYmplY3QodCksCiAgCSAgICAgIHIgPSBbXTsKICAJICAgIGZvciAodmFyIG4gaW4gZSkgci5wdXNoKG4pOwogIAkgICAgcmV0dXJuIHIucmV2ZXJzZSgpLCBmdW5jdGlvbiBuZXh0KCkgewogIAkgICAgICBmb3IgKDsgci5sZW5ndGg7KSB7CiAgCSAgICAgICAgdmFyIHQgPSByLnBvcCgpOwogIAkgICAgICAgIGlmICh0IGluIGUpIHJldHVybiBuZXh0LnZhbHVlID0gdCwgbmV4dC5kb25lID0gITEsIG5leHQ7CiAgCSAgICAgIH0KICAJICAgICAgcmV0dXJuIG5leHQuZG9uZSA9ICEwLCBuZXh0OwogIAkgICAgfTsKICAJICB9LCBlLnZhbHVlcyA9IHZhbHVlcywgQ29udGV4dC5wcm90b3R5cGUgPSB7CiAgCSAgICBjb25zdHJ1Y3RvcjogQ29udGV4dCwKICAJICAgIHJlc2V0OiBmdW5jdGlvbiByZXNldChlKSB7CiAgCSAgICAgIGlmICh0aGlzLnByZXYgPSAwLCB0aGlzLm5leHQgPSAwLCB0aGlzLnNlbnQgPSB0aGlzLl9zZW50ID0gdCwgdGhpcy5kb25lID0gITEsIHRoaXMuZGVsZWdhdGUgPSBudWxsLCB0aGlzLm1ldGhvZCA9ICJuZXh0IiwgdGhpcy5hcmcgPSB0LCB0aGlzLnRyeUVudHJpZXMuZm9yRWFjaChyZXNldFRyeUVudHJ5KSwgIWUpIGZvciAodmFyIHIgaW4gdGhpcykgInQiID09PSByLmNoYXJBdCgwKSAmJiBuLmNhbGwodGhpcywgcikgJiYgIWlzTmFOKCtyLnNsaWNlKDEpKSAmJiAodGhpc1tyXSA9IHQpOwogIAkgICAgfSwKICAJICAgIHN0b3A6IGZ1bmN0aW9uIHN0b3AoKSB7CiAgCSAgICAgIHRoaXMuZG9uZSA9ICEwOwogIAkgICAgICB2YXIgdCA9IHRoaXMudHJ5RW50cmllc1swXS5jb21wbGV0aW9uOwogIAkgICAgICBpZiAoInRocm93IiA9PT0gdC50eXBlKSB0aHJvdyB0LmFyZzsKICAJICAgICAgcmV0dXJuIHRoaXMucnZhbDsKICAJICAgIH0sCiAgCSAgICBkaXNwYXRjaEV4Y2VwdGlvbjogZnVuY3Rpb24gZGlzcGF0Y2hFeGNlcHRpb24oZSkgewogIAkgICAgICBpZiAodGhpcy5kb25lKSB0aHJvdyBlOwogIAkgICAgICB2YXIgciA9IHRoaXM7CiAgCSAgICAgIGZ1bmN0aW9uIGhhbmRsZShuLCBvKSB7CiAgCSAgICAgICAgcmV0dXJuIGEudHlwZSA9ICJ0aHJvdyIsIGEuYXJnID0gZSwgci5uZXh0ID0gbiwgbyAmJiAoci5tZXRob2QgPSAibmV4dCIsIHIuYXJnID0gdCksICEhbzsKICAJICAgICAgfQogIAkgICAgICBmb3IgKHZhciBvID0gdGhpcy50cnlFbnRyaWVzLmxlbmd0aCAtIDE7IG8gPj0gMDsgLS1vKSB7CiAgCSAgICAgICAgdmFyIGkgPSB0aGlzLnRyeUVudHJpZXNbb10sCiAgCSAgICAgICAgICBhID0gaS5jb21wbGV0aW9uOwogIAkgICAgICAgIGlmICgicm9vdCIgPT09IGkudHJ5TG9jKSByZXR1cm4gaGFuZGxlKCJlbmQiKTsKICAJICAgICAgICBpZiAoaS50cnlMb2MgPD0gdGhpcy5wcmV2KSB7CiAgCSAgICAgICAgICB2YXIgYyA9IG4uY2FsbChpLCAiY2F0Y2hMb2MiKSwKICAJICAgICAgICAgICAgdSA9IG4uY2FsbChpLCAiZmluYWxseUxvYyIpOwogIAkgICAgICAgICAgaWYgKGMgJiYgdSkgewogIAkgICAgICAgICAgICBpZiAodGhpcy5wcmV2IDwgaS5jYXRjaExvYykgcmV0dXJuIGhhbmRsZShpLmNhdGNoTG9jLCAhMCk7CiAgCSAgICAgICAgICAgIGlmICh0aGlzLnByZXYgPCBpLmZpbmFsbHlMb2MpIHJldHVybiBoYW5kbGUoaS5maW5hbGx5TG9jKTsKICAJICAgICAgICAgIH0gZWxzZSBpZiAoYykgewogIAkgICAgICAgICAgICBpZiAodGhpcy5wcmV2IDwgaS5jYXRjaExvYykgcmV0dXJuIGhhbmRsZShpLmNhdGNoTG9jLCAhMCk7CiAgCSAgICAgICAgICB9IGVsc2UgewogIAkgICAgICAgICAgICBpZiAoIXUpIHRocm93IG5ldyBFcnJvcigidHJ5IHN0YXRlbWVudCB3aXRob3V0IGNhdGNoIG9yIGZpbmFsbHkiKTsKICAJICAgICAgICAgICAgaWYgKHRoaXMucHJldiA8IGkuZmluYWxseUxvYykgcmV0dXJuIGhhbmRsZShpLmZpbmFsbHlMb2MpOwogIAkgICAgICAgICAgfQogIAkgICAgICAgIH0KICAJICAgICAgfQogIAkgICAgfSwKICAJICAgIGFicnVwdDogZnVuY3Rpb24gYWJydXB0KHQsIGUpIHsKICAJICAgICAgZm9yICh2YXIgciA9IHRoaXMudHJ5RW50cmllcy5sZW5ndGggLSAxOyByID49IDA7IC0tcikgewogIAkgICAgICAgIHZhciBvID0gdGhpcy50cnlFbnRyaWVzW3JdOwogIAkgICAgICAgIGlmIChvLnRyeUxvYyA8PSB0aGlzLnByZXYgJiYgbi5jYWxsKG8sICJmaW5hbGx5TG9jIikgJiYgdGhpcy5wcmV2IDwgby5maW5hbGx5TG9jKSB7CiAgCSAgICAgICAgICB2YXIgaSA9IG87CiAgCSAgICAgICAgICBicmVhazsKICAJICAgICAgICB9CiAgCSAgICAgIH0KICAJICAgICAgaSAmJiAoImJyZWFrIiA9PT0gdCB8fCAiY29udGludWUiID09PSB0KSAmJiBpLnRyeUxvYyA8PSBlICYmIGUgPD0gaS5maW5hbGx5TG9jICYmIChpID0gbnVsbCk7CiAgCSAgICAgIHZhciBhID0gaSA/IGkuY29tcGxldGlvbiA6IHt9OwogIAkgICAgICByZXR1cm4gYS50eXBlID0gdCwgYS5hcmcgPSBlLCBpID8gKHRoaXMubWV0aG9kID0gIm5leHQiLCB0aGlzLm5leHQgPSBpLmZpbmFsbHlMb2MsIHkpIDogdGhpcy5jb21wbGV0ZShhKTsKICAJICAgIH0sCiAgCSAgICBjb21wbGV0ZTogZnVuY3Rpb24gY29tcGxldGUodCwgZSkgewogIAkgICAgICBpZiAoInRocm93IiA9PT0gdC50eXBlKSB0aHJvdyB0LmFyZzsKICAJICAgICAgcmV0dXJuICJicmVhayIgPT09IHQudHlwZSB8fCAiY29udGludWUiID09PSB0LnR5cGUgPyB0aGlzLm5leHQgPSB0LmFyZyA6ICJyZXR1cm4iID09PSB0LnR5cGUgPyAodGhpcy5ydmFsID0gdGhpcy5hcmcgPSB0LmFyZywgdGhpcy5tZXRob2QgPSAicmV0dXJuIiwgdGhpcy5uZXh0ID0gImVuZCIpIDogIm5vcm1hbCIgPT09IHQudHlwZSAmJiBlICYmICh0aGlzLm5leHQgPSBlKSwgeTsKICAJICAgIH0sCiAgCSAgICBmaW5pc2g6IGZ1bmN0aW9uIGZpbmlzaCh0KSB7CiAgCSAgICAgIGZvciAodmFyIGUgPSB0aGlzLnRyeUVudHJpZXMubGVuZ3RoIC0gMTsgZSA+PSAwOyAtLWUpIHsKICAJICAgICAgICB2YXIgciA9IHRoaXMudHJ5RW50cmllc1tlXTsKICAJICAgICAgICBpZiAoci5maW5hbGx5TG9jID09PSB0KSByZXR1cm4gdGhpcy5jb21wbGV0ZShyLmNvbXBsZXRpb24sIHIuYWZ0ZXJMb2MpLCByZXNldFRyeUVudHJ5KHIpLCB5OwogIAkgICAgICB9CiAgCSAgICB9LAogIAkgICAgImNhdGNoIjogZnVuY3Rpb24gX2NhdGNoKHQpIHsKICAJICAgICAgZm9yICh2YXIgZSA9IHRoaXMudHJ5RW50cmllcy5sZW5ndGggLSAxOyBlID49IDA7IC0tZSkgewogIAkgICAgICAgIHZhciByID0gdGhpcy50cnlFbnRyaWVzW2VdOwogIAkgICAgICAgIGlmIChyLnRyeUxvYyA9PT0gdCkgewogIAkgICAgICAgICAgdmFyIG4gPSByLmNvbXBsZXRpb247CiAgCSAgICAgICAgICBpZiAoInRocm93IiA9PT0gbi50eXBlKSB7CiAgCSAgICAgICAgICAgIHZhciBvID0gbi5hcmc7CiAgCSAgICAgICAgICAgIHJlc2V0VHJ5RW50cnkocik7CiAgCSAgICAgICAgICB9CiAgCSAgICAgICAgICByZXR1cm4gbzsKICAJICAgICAgICB9CiAgCSAgICAgIH0KICAJICAgICAgdGhyb3cgbmV3IEVycm9yKCJpbGxlZ2FsIGNhdGNoIGF0dGVtcHQiKTsKICAJICAgIH0sCiAgCSAgICBkZWxlZ2F0ZVlpZWxkOiBmdW5jdGlvbiBkZWxlZ2F0ZVlpZWxkKGUsIHIsIG4pIHsKICAJICAgICAgcmV0dXJuIHRoaXMuZGVsZWdhdGUgPSB7CiAgCSAgICAgICAgaXRlcmF0b3I6IHZhbHVlcyhlKSwKICAJICAgICAgICByZXN1bHROYW1lOiByLAogIAkgICAgICAgIG5leHRMb2M6IG4KICAJICAgICAgfSwgIm5leHQiID09PSB0aGlzLm1ldGhvZCAmJiAodGhpcy5hcmcgPSB0KSwgeTsKICAJICAgIH0KICAJICB9LCBlOwogIAl9CiAgCW1vZHVsZS5leHBvcnRzID0gX3JlZ2VuZXJhdG9yUnVudGltZSwgbW9kdWxlLmV4cG9ydHMuX19lc01vZHVsZSA9IHRydWUsIG1vZHVsZS5leHBvcnRzWyJkZWZhdWx0Il0gPSBtb2R1bGUuZXhwb3J0czsgCiAgfSAocmVnZW5lcmF0b3JSdW50aW1lJDEpKTsKCiAgdmFyIHJlZ2VuZXJhdG9yUnVudGltZUV4cG9ydHMgPSByZWdlbmVyYXRvclJ1bnRpbWUkMS5leHBvcnRzOwoKICAvLyBUT0RPKEJhYmVsIDgpOiBSZW1vdmUgdGhpcyBmaWxlLgoKICB2YXIgcnVudGltZSA9IHJlZ2VuZXJhdG9yUnVudGltZUV4cG9ydHMoKTsKICB2YXIgcmVnZW5lcmF0b3IgPSBydW50aW1lOwoKICAvLyBDb3BpZWQgZnJvbSBodHRwczovL2dpdGh1Yi5jb20vZmFjZWJvb2svcmVnZW5lcmF0b3IvYmxvYi9tYWluL3BhY2thZ2VzL3J1bnRpbWUvcnVudGltZS5qcyNMNzM2PQogIHRyeSB7CiAgICByZWdlbmVyYXRvclJ1bnRpbWUgPSBydW50aW1lOwogIH0gY2F0Y2ggKGFjY2lkZW50YWxTdHJpY3RNb2RlKSB7CiAgICBpZiAodHlwZW9mIGdsb2JhbFRoaXMgPT09ICJvYmplY3QiKSB7CiAgICAgIGdsb2JhbFRoaXMucmVnZW5lcmF0b3JSdW50aW1lID0gcnVudGltZTsKICAgIH0gZWxzZSB7CiAgICAgIEZ1bmN0aW9uKCJyIiwgInJlZ2VuZXJhdG9yUnVudGltZSA9IHIiKShydW50aW1lKTsKICAgIH0KICB9CgogIHZhciBfcmVnZW5lcmF0b3JSdW50aW1lID0gLypAX19QVVJFX18qL2dldERlZmF1bHRFeHBvcnRGcm9tQ2pzKHJlZ2VuZXJhdG9yKTsKCiAgdmFyIFB2WHB1QWN0aW9uOwogIChmdW5jdGlvbiAoUHZYcHVBY3Rpb24pIHsKICAgIFB2WHB1QWN0aW9uW1B2WHB1QWN0aW9uWyJJTklUIl0gPSAwXSA9ICJJTklUIjsKICAgIFB2WHB1QWN0aW9uW1B2WHB1QWN0aW9uWyJBTExPQyJdID0gMV0gPSAiQUxMT0MiOwogICAgUHZYcHVBY3Rpb25bUHZYcHVBY3Rpb25bIkZSRUUiXSA9IDJdID0gIkZSRUUiOwogICAgUHZYcHVBY3Rpb25bUHZYcHVBY3Rpb25bIkNPUFlfVE9fWFBVIl0gPSAzXSA9ICJDT1BZX1RPX1hQVSI7CiAgICBQdlhwdUFjdGlvbltQdlhwdUFjdGlvblsiQ09QWV9GUk9NX1hQVSJdID0gNF0gPSAiQ09QWV9GUk9NX1hQVSI7CiAgICAvLyBvdGhlciB4cHUgYWN0aW9ucwogICAgUHZYcHVBY3Rpb25bUHZYcHVBY3Rpb25bIk1BVFJJWF9WRUNUT1JfTVVMVElQTFkiXSA9IDVdID0gIk1BVFJJWF9WRUNUT1JfTVVMVElQTFkiOwogICAgUHZYcHVBY3Rpb25bUHZYcHVBY3Rpb25bIlNZTkNfVkVDVE9SIl0gPSA2XSA9ICJTWU5DX1ZFQ1RPUiI7CiAgfSkoUHZYcHVBY3Rpb24gfHwgKFB2WHB1QWN0aW9uID0ge30pKTsKCiAgY29uc3Qgd2FzaV9zbmFwc2hvdF9wcmV2aWV3MV9lbXVsYXRvciA9IHsKICAgIGFyZ3NfZ2V0OiAoaW5wdXQpID0+IHsKICAgICAgcmV0dXJuIDA7CiAgICB9LAogICAgYXJnc19zaXplc19nZXQ6IChpbnB1dCkgPT4gewogICAgICByZXR1cm4gMDsKICAgIH0sCiAgICBlbnZpcm9uX2dldDogKGlucHV0KSA9PiB7CiAgICAgIHJldHVybiAwOwogICAgfSwKICAgIGVudmlyb25fc2l6ZXNfZ2V0OiAoaW5wdXQpID0+IHsKICAgICAgcmV0dXJuIDA7CiAgICB9LAogICAgY2xvY2tfcmVzX2dldDogKGlucHV0KSA9PiB7CiAgICAgIHJldHVybiAwOwogICAgfSwKICAgIGNsb2NrX3RpbWVfZ2V0OiAoaW5wdXQpID0+IHsKICAgICAgcmV0dXJuIDA7CiAgICB9LAogICAgZmRfYWR2aXNlOiAoaW5wdXQpID0+IHsKICAgICAgcmV0dXJuIDA7CiAgICB9LAogICAgZmRfYWxsb2NhdGU6IChpbnB1dCkgPT4gewogICAgICByZXR1cm4gMDsKICAgIH0sCiAgICBmZF9jbG9zZTogKGlucHV0KSA9PiB7CiAgICAgIHJldHVybiAwOwogICAgfSwKICAgIGZkX2RhdGFzeW5jOiAoaW5wdXQpID0+IHsKICAgICAgcmV0dXJuIDA7CiAgICB9LAogICAgZmRfZmRzdGF0X2dldDogKGlucHV0KSA9PiB7CiAgICAgIHJldHVybiAwOwogICAgfSwKICAgIGZkX2Zkc3RhdF9zZXRfZmxhZ3M6IChpbnB1dCkgPT4gewogICAgICByZXR1cm4gMDsKICAgIH0sCiAgICBmZF9mZHN0YXRfc2V0X3JpZ2h0czogKGlucHV0KSA9PiB7CiAgICAgIHJldHVybiAwOwogICAgfSwKICAgIGZkX2ZpbGVzdGF0X2dldDogKGlucHV0KSA9PiB7CiAgICAgIHJldHVybiAwOwogICAgfSwKICAgIGZkX2ZpbGVzdGF0X3NldF9zaXplOiAoaW5wdXQpID0+IHsKICAgICAgcmV0dXJuIDA7CiAgICB9LAogICAgZmRfZmlsZXN0YXRfc2V0X3RpbWVzOiAoaW5wdXQpID0+IHsKICAgICAgcmV0dXJuIDA7CiAgICB9LAogICAgZmRfcHJlYWQ6IChpbnB1dCkgPT4gewogICAgICByZXR1cm4gMDsKICAgIH0sCiAgICBmZF9wcmVzdGF0X2dldDogKGlucHV0KSA9PiB7CiAgICAgIHJldHVybiAwOwogICAgfSwKICAgIGZkX3ByZXN0YXRfZGlyX25hbWU6IChpbnB1dCkgPT4gewogICAgICByZXR1cm4gMDsKICAgIH0sCiAgICBmZF9wd3JpdGU6IChpbnB1dCkgPT4gewogICAgICByZXR1cm4gMDsKICAgIH0sCiAgICBmZF9yZWFkOiAoaW5wdXQpID0+IHsKICAgICAgcmV0dXJuIDA7CiAgICB9LAogICAgZmRfcmVhZGRpcjogKGlucHV0KSA9PiB7CiAgICAgIHJldHVybiAwOwogICAgfSwKICAgIGZkX3JlbnVtYmVyOiAoaW5wdXQpID0+IHsKICAgICAgcmV0dXJuIDA7CiAgICB9LAogICAgZmRfc2VlazogKGlucHV0KSA9PiB7CiAgICAgIHJldHVybiAwOwogICAgfSwKICAgIGZkX3N5bmM6IChpbnB1dCkgPT4gewogICAgICByZXR1cm4gMDsKICAgIH0sCiAgICBmZF90ZWxsOiAoaW5wdXQpID0+IHsKICAgICAgcmV0dXJuIDA7CiAgICB9LAogICAgZmRfd3JpdGU6IChpbnB1dCkgPT4gewogICAgICByZXR1cm4gMDsKICAgIH0sCiAgICBwYXRoX2NyZWF0ZV9kaXJlY3Rvcnk6IChpbnB1dCkgPT4gewogICAgICByZXR1cm4gMDsKICAgIH0sCiAgICBwYXRoX2ZpbGVzdGF0X2dldDogKGlucHV0KSA9PiB7CiAgICAgIHJldHVybiAwOwogICAgfSwKICAgIHBhdGhfZmlsZXN0YXRfc2V0X3RpbWVzOiAoaW5wdXQpID0+IHsKICAgICAgcmV0dXJuIDA7CiAgICB9LAogICAgcGF0aF9saW5rOiAoaW5wdXQpID0+IHsKICAgICAgcmV0dXJuIDA7CiAgICB9LAogICAgcGF0aF9vcGVuOiAoaW5wdXQpID0+IHsKICAgICAgcmV0dXJuIDA7CiAgICB9LAogICAgcGF0aF9yZWFkbGluazogKGlucHV0KSA9PiB7CiAgICAgIHJldHVybiAwOwogICAgfSwKICAgIHBhdGhfcmVtb3ZlX2RpcmVjdG9yeTogKGlucHV0KSA9PiB7CiAgICAgIHJldHVybiAwOwogICAgfSwKICAgIHBhdGhfcmVuYW1lOiAoaW5wdXQpID0+IHsKICAgICAgcmV0dXJuIDA7CiAgICB9LAogICAgcGF0aF9zeW1saW5rOiAoaW5wdXQpID0+IHsKICAgICAgcmV0dXJuIDA7CiAgICB9LAogICAgcGF0aF91bmxpbmtfZmlsZTogKGlucHV0KSA9PiB7CiAgICAgIHJldHVybiAwOwogICAgfSwKICAgIHBvbGxfb25lb2ZmOiAoaW5wdXQpID0+IHsKICAgICAgcmV0dXJuIDA7CiAgICB9LAogICAgcHJvY19leGl0OiAoaW5wdXQpID0+IHsKICAgICAgcmV0dXJuIDA7CiAgICB9LAogICAgcHJvY19yYWlzZTogKGlucHV0KSA9PiB7CiAgICAgIHJldHVybiAwOwogICAgfSwKICAgIHNjaGVkX3lpZWxkOiAoaW5wdXQpID0+IHsKICAgICAgcmV0dXJuIDA7CiAgICB9LAogICAgcmFuZG9tX2dldDogKGlucHV0KSA9PiB7CiAgICAgIHJldHVybiAwOwogICAgfSwKICAgIHNvY2tfcmVjdjogKGlucHV0KSA9PiB7CiAgICAgIHJldHVybiAwOwogICAgfSwKICAgIHNvY2tfc2VuZDogKGlucHV0KSA9PiB7CiAgICAgIHJldHVybiAwOwogICAgfSwKICAgIHNvY2tfc2h1dGRvd246IChpbnB1dCkgPT4gewogICAgICByZXR1cm4gMDsKICAgIH0sCiAgfTsKCiAgdmFyIG1hdHJpeFZlY3Rvck11bHRpcGx5ID0gZnVuY3Rpb24gbWF0cml4VmVjdG9yTXVsdGlwbHkoZGF0YSkgewogICAgdHJ5IHsKICAgICAgdmFyIF9kYXRhJGdsb2JhbHMgPSBkYXRhLmdsb2JhbHMsCiAgICAgICAgZXhwb3J0cyA9IF9kYXRhJGdsb2JhbHMuZXhwb3J0cywKICAgICAgICBtZW1BbGxvYyA9IF9kYXRhJGdsb2JhbHMubWVtQWxsb2MsCiAgICAgICAgbWVtb3J5ID0gX2RhdGEkZ2xvYmFscy5tZW1vcnk7CiAgICAgIHZhciBtYXRyaXhBZGRyZXNzID0gZGF0YS5tYXRyaXhBZGRyZXNzLAogICAgICAgIHZlY3RvckFkZHJlc3MgPSBkYXRhLnZlY3RvckFkZHJlc3MsCiAgICAgICAgbSA9IGRhdGEubSwKICAgICAgICBuID0gZGF0YS5uLAogICAgICAgIHJlc3VsdEFkZHJlc3MgPSBkYXRhLnJlc3VsdEFkZHJlc3M7CiAgICAgIHZhciBwdl9tYXRyaXhfdmVjdG9yX211bHRpcGx5ID0gZXhwb3J0cy5wdl9tYXRyaXhfdmVjdG9yX211bHRpcGx5OwogICAgICBpZiAoIW1lbUFsbG9jLmhhcyhtYXRyaXhBZGRyZXNzKSB8fCAhbWVtQWxsb2MuaGFzKHZlY3RvckFkZHJlc3MpIHx8ICFtZW1BbGxvYy5oYXMocmVzdWx0QWRkcmVzcykpIHsKICAgICAgICBzZWxmLnBvc3RNZXNzYWdlKHsKICAgICAgICAgIGNvbW1hbmQ6ICdvaycsCiAgICAgICAgICByZXN1bHQ6IG5ldyBGbG9hdDMyQXJyYXkoMCkKICAgICAgICB9KTsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgdmFyIG1lbW9yeUJ1ZmZlckZsb2F0MzIgPSBuZXcgRmxvYXQzMkFycmF5KG1lbW9yeS5idWZmZXIpOwogICAgICB2YXIgX21lbUFsbG9jJGdldCA9IG1lbUFsbG9jLmdldChtYXRyaXhBZGRyZXNzKSwKICAgICAgICB3b3JrZXJNYXRyaXhBZGRyZXNzID0gX21lbUFsbG9jJGdldC53b3JrZXJNZW1BZGRyZXNzOwogICAgICB2YXIgX21lbUFsbG9jJGdldDIgPSBtZW1BbGxvYy5nZXQodmVjdG9yQWRkcmVzcyksCiAgICAgICAgd29ya2VyVmVjdG9yQWRkcmVzcyA9IF9tZW1BbGxvYyRnZXQyLndvcmtlck1lbUFkZHJlc3M7CiAgICAgIHZhciBfbWVtQWxsb2MkZ2V0MyA9IG1lbUFsbG9jLmdldChyZXN1bHRBZGRyZXNzKSwKICAgICAgICB3b3JrZXJSZXN1bHRBZGRyZXNzID0gX21lbUFsbG9jJGdldDMud29ya2VyTWVtQWRkcmVzczsKICAgICAgcHZfbWF0cml4X3ZlY3Rvcl9tdWx0aXBseSh3b3JrZXJNYXRyaXhBZGRyZXNzLCB3b3JrZXJWZWN0b3JBZGRyZXNzLCBtLCBuLCB3b3JrZXJSZXN1bHRBZGRyZXNzKTsKICAgICAgdmFyIHJlc3VsdCA9IG1lbW9yeUJ1ZmZlckZsb2F0MzIuc2xpY2Uod29ya2VyUmVzdWx0QWRkcmVzcyAvIEZsb2F0MzJBcnJheS5CWVRFU19QRVJfRUxFTUVOVCwgd29ya2VyUmVzdWx0QWRkcmVzcyAvIEZsb2F0MzJBcnJheS5CWVRFU19QRVJfRUxFTUVOVCArIG0pOwogICAgICBzZWxmLnBvc3RNZXNzYWdlKHsKICAgICAgICBjb21tYW5kOiAnb2snLAogICAgICAgIHJlc3VsdDogcmVzdWx0CiAgICAgIH0pOwogICAgfSBjYXRjaCAoZSkgewogICAgICBzZWxmLnBvc3RNZXNzYWdlKHsKICAgICAgICBjb21tYW5kOiAnZXJyb3InLAogICAgICAgIG1lc3NhZ2U6IGUubWVzc2FnZQogICAgICB9KTsKICAgIH0KICB9OwogIHZhciBzeW5jVmVjdG9yID0gZnVuY3Rpb24gc3luY1ZlY3RvcihkYXRhKSB7CiAgICB0cnkgewogICAgICB2YXIgX2RhdGEkZ2xvYmFsczIgPSBkYXRhLmdsb2JhbHMsCiAgICAgICAgbWVtQWxsb2MgPSBfZGF0YSRnbG9iYWxzMi5tZW1BbGxvYywKICAgICAgICBtZW1vcnkgPSBfZGF0YSRnbG9iYWxzMi5tZW1vcnk7CiAgICAgIHZhciB2ZWN0b3JBZGRyZXNzID0gZGF0YS52ZWN0b3JBZGRyZXNzLAogICAgICAgIGJ1ZmZlciA9IGRhdGEuYnVmZmVyOwogICAgICBpZiAobWVtQWxsb2MuaGFzKHZlY3RvckFkZHJlc3MpKSB7CiAgICAgICAgdmFyIG1lbW9yeUJ1ZmZlckZsb2F0MzIgPSBuZXcgRmxvYXQzMkFycmF5KG1lbW9yeS5idWZmZXIpOwogICAgICAgIHZhciBfbWVtQWxsb2MkZ2V0NCA9IG1lbUFsbG9jLmdldCh2ZWN0b3JBZGRyZXNzKSwKICAgICAgICAgIHdvcmtlck1lbUFkZHJlc3MgPSBfbWVtQWxsb2MkZ2V0NC53b3JrZXJNZW1BZGRyZXNzOwogICAgICAgIG1lbW9yeUJ1ZmZlckZsb2F0MzIuc2V0KGJ1ZmZlciwgd29ya2VyTWVtQWRkcmVzcyAvIEZsb2F0MzJBcnJheS5CWVRFU19QRVJfRUxFTUVOVCk7CiAgICAgIH0KICAgICAgc2VsZi5wb3N0TWVzc2FnZSh7CiAgICAgICAgY29tbWFuZDogJ29rJwogICAgICB9KTsKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgc2VsZi5wb3N0TWVzc2FnZSh7CiAgICAgICAgY29tbWFuZDogJ2Vycm9yJywKICAgICAgICBtZXNzYWdlOiBlLm1lc3NhZ2UKICAgICAgfSk7CiAgICB9CiAgfTsKICB2YXIgcHZNdm1BY3Rpb25NYXAgPSBfZGVmaW5lUHJvcGVydHkoX2RlZmluZVByb3BlcnR5KHt9LCBQdlhwdUFjdGlvbi5NQVRSSVhfVkVDVE9SX01VTFRJUExZLCBtYXRyaXhWZWN0b3JNdWx0aXBseSksIFB2WHB1QWN0aW9uLlNZTkNfVkVDVE9SLCBzeW5jVmVjdG9yKTsKCiAgZnVuY3Rpb24gb3duS2V5cyhlLCByKSB7IHZhciB0ID0gT2JqZWN0LmtleXMoZSk7IGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7IHZhciBvID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsgciAmJiAobyA9IG8uZmlsdGVyKGZ1bmN0aW9uIChyKSB7IHJldHVybiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGUsIHIpLmVudW1lcmFibGU7IH0pKSwgdC5wdXNoLmFwcGx5KHQsIG8pOyB9IHJldHVybiB0OyB9CiAgZnVuY3Rpb24gX29iamVjdFNwcmVhZChlKSB7IGZvciAodmFyIHIgPSAxOyByIDwgYXJndW1lbnRzLmxlbmd0aDsgcisrKSB7IHZhciB0ID0gbnVsbCAhPSBhcmd1bWVudHNbcl0gPyBhcmd1bWVudHNbcl0gOiB7fTsgciAlIDIgPyBvd25LZXlzKE9iamVjdCh0KSwgITApLmZvckVhY2goZnVuY3Rpb24gKHIpIHsgX2RlZmluZVByb3BlcnR5KGUsIHIsIHRbcl0pOyB9KSA6IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzID8gT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoZSwgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnModCkpIDogb3duS2V5cyhPYmplY3QodCkpLmZvckVhY2goZnVuY3Rpb24gKHIpIHsgT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodCwgcikpOyB9KTsgfSByZXR1cm4gZTsgfQogIHZhciBleHBvcnRzJDEgPSBudWxsOwogIHZhciBtZW1vcnk7CiAgdmFyIG1lbUFsbG9jID0gbmV3IE1hcCgpOwogIHZhciBnZXRXYXNtID0gLyojX19QVVJFX18qL2Z1bmN0aW9uICgpIHsKICAgIHZhciBfcmVmID0gX2FzeW5jVG9HZW5lcmF0b3IoIC8qI19fUFVSRV9fKi9fcmVnZW5lcmF0b3JSdW50aW1lLm1hcmsoZnVuY3Rpb24gX2NhbGxlZSh3YXNtKSB7CiAgICAgIHZhciBpbnN0YW5jZTsKICAgICAgcmV0dXJuIF9yZWdlbmVyYXRvclJ1bnRpbWUud3JhcChmdW5jdGlvbiBfY2FsbGVlJChfY29udGV4dCkgewogICAgICAgIHdoaWxlICgxKSBzd2l0Y2ggKF9jb250ZXh0LnByZXYgPSBfY29udGV4dC5uZXh0KSB7CiAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgIF9jb250ZXh0Lm5leHQgPSAyOwogICAgICAgICAgICByZXR1cm4gV2ViQXNzZW1ibHkuaW5zdGFudGlhdGUod2FzbSwgewogICAgICAgICAgICAgIHdhc2lfc25hcHNob3RfcHJldmlldzE6IHdhc2lfc25hcHNob3RfcHJldmlldzFfZW11bGF0b3IsCiAgICAgICAgICAgICAgZW52OiB7CiAgICAgICAgICAgICAgICBtZW1vcnk6IG1lbW9yeQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICBjYXNlIDI6CiAgICAgICAgICAgIGluc3RhbmNlID0gX2NvbnRleHQuc2VudC5pbnN0YW5jZTsKICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0LmFicnVwdCgicmV0dXJuIiwgaW5zdGFuY2UuZXhwb3J0cyk7CiAgICAgICAgICBjYXNlIDQ6CiAgICAgICAgICBjYXNlICJlbmQiOgogICAgICAgICAgICByZXR1cm4gX2NvbnRleHQuc3RvcCgpOwogICAgICAgIH0KICAgICAgfSwgX2NhbGxlZSk7CiAgICB9KSk7CiAgICByZXR1cm4gZnVuY3Rpb24gZ2V0V2FzbShfeCkgewogICAgICByZXR1cm4gX3JlZi5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfTsKICB9KCk7CiAgdmFyIGluaXQgPSAvKiNfX1BVUkVfXyovZnVuY3Rpb24gKCkgewogICAgdmFyIF9yZWYyID0gX2FzeW5jVG9HZW5lcmF0b3IoIC8qI19fUFVSRV9fKi9fcmVnZW5lcmF0b3JSdW50aW1lLm1hcmsoZnVuY3Rpb24gX2NhbGxlZTIoZGF0YSkgewogICAgICByZXR1cm4gX3JlZ2VuZXJhdG9yUnVudGltZS53cmFwKGZ1bmN0aW9uIF9jYWxsZWUyJChfY29udGV4dDIpIHsKICAgICAgICB3aGlsZSAoMSkgc3dpdGNoIChfY29udGV4dDIucHJldiA9IF9jb250ZXh0Mi5uZXh0KSB7CiAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgIF9jb250ZXh0Mi5wcmV2ID0gMDsKICAgICAgICAgICAgbWVtb3J5ID0gbmV3IFdlYkFzc2VtYmx5Lk1lbW9yeSh7CiAgICAgICAgICAgICAgaW5pdGlhbDogNDA5NgogICAgICAgICAgICB9KTsKICAgICAgICAgICAgX2NvbnRleHQyLm5leHQgPSA0OwogICAgICAgICAgICByZXR1cm4gZ2V0V2FzbShkYXRhLndhc20pOwogICAgICAgICAgY2FzZSA0OgogICAgICAgICAgICBleHBvcnRzJDEgPSBfY29udGV4dDIuc2VudDsKICAgICAgICAgICAgc2VsZi5wb3N0TWVzc2FnZSh7CiAgICAgICAgICAgICAgY29tbWFuZDogJ29rJwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgX2NvbnRleHQyLm5leHQgPSAxMTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlIDg6CiAgICAgICAgICAgIF9jb250ZXh0Mi5wcmV2ID0gODsKICAgICAgICAgICAgX2NvbnRleHQyLnQwID0gX2NvbnRleHQyWyJjYXRjaCJdKDApOwogICAgICAgICAgICBzZWxmLnBvc3RNZXNzYWdlKHsKICAgICAgICAgICAgICBjb21tYW5kOiAnZXJyb3InLAogICAgICAgICAgICAgIG1lc3NhZ2U6IF9jb250ZXh0Mi50MC5tZXNzYWdlCiAgICAgICAgICAgIH0pOwogICAgICAgICAgY2FzZSAxMToKICAgICAgICAgIGNhc2UgImVuZCI6CiAgICAgICAgICAgIHJldHVybiBfY29udGV4dDIuc3RvcCgpOwogICAgICAgIH0KICAgICAgfSwgX2NhbGxlZTIsIG51bGwsIFtbMCwgOF1dKTsKICAgIH0pKTsKICAgIHJldHVybiBmdW5jdGlvbiBpbml0KF94MikgewogICAgICByZXR1cm4gX3JlZjIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH07CiAgfSgpOwogIHZhciBhbGxvY01lbSA9IGZ1bmN0aW9uIGFsbG9jTWVtKGRhdGEpIHsKICAgIHRyeSB7CiAgICAgIHZhciBzaXplID0gZGF0YS5zaXplLAogICAgICAgIG1lbUFkZHJlc3MgPSBkYXRhLm1lbUFkZHJlc3M7CiAgICAgIHZhciBfZXhwb3J0cyA9IGV4cG9ydHMkMSwKICAgICAgICBhbGlnbmVkX2FsbG9jID0gX2V4cG9ydHMuYWxpZ25lZF9hbGxvYzsKICAgICAgaWYgKHNpemUgPiAwKSB7CiAgICAgICAgdmFyIHdvcmtlck1lbUFkZHJlc3MgPSBhbGlnbmVkX2FsbG9jKFVpbnQ4QXJyYXkuQllURVNfUEVSX0VMRU1FTlQsIHNpemUgKiBVaW50OEFycmF5LkJZVEVTX1BFUl9FTEVNRU5UKTsKICAgICAgICBtZW1BbGxvYy5zZXQobWVtQWRkcmVzcywgewogICAgICAgICAgYWxsb2NTaXplOiBzaXplLAogICAgICAgICAgd29ya2VyTWVtQWRkcmVzczogd29ya2VyTWVtQWRkcmVzcwogICAgICAgIH0pOwogICAgICB9CiAgICAgIHNlbGYucG9zdE1lc3NhZ2UoewogICAgICAgIGNvbW1hbmQ6ICdvaycKICAgICAgfSk7CiAgICB9IGNhdGNoIChlKSB7CiAgICAgIHNlbGYucG9zdE1lc3NhZ2UoewogICAgICAgIGNvbW1hbmQ6ICdlcnJvcicsCiAgICAgICAgbWVzc2FnZTogZS5tZXNzYWdlCiAgICAgIH0pOwogICAgfQogIH07CiAgdmFyIGZyZWVNZW0gPSBmdW5jdGlvbiBmcmVlTWVtKGRhdGEpIHsKICAgIHRyeSB7CiAgICAgIHZhciBtZW1BZGRyZXNzID0gZGF0YS5tZW1BZGRyZXNzOwogICAgICB2YXIgX2V4cG9ydHMyID0gZXhwb3J0cyQxLAogICAgICAgIGZyZWUgPSBfZXhwb3J0czIuZnJlZTsKICAgICAgaWYgKG1lbUFsbG9jLmhhcyhtZW1BZGRyZXNzKSkgewogICAgICAgIHZhciBfbWVtQWxsb2MkZ2V0ID0gbWVtQWxsb2MuZ2V0KG1lbUFkZHJlc3MpLAogICAgICAgICAgd29ya2VyTWVtQWRkcmVzcyA9IF9tZW1BbGxvYyRnZXQud29ya2VyTWVtQWRkcmVzczsKICAgICAgICBmcmVlKHdvcmtlck1lbUFkZHJlc3MpOwogICAgICAgIG1lbUFsbG9jWyJkZWxldGUiXShtZW1BZGRyZXNzKTsKICAgICAgfQogICAgICBzZWxmLnBvc3RNZXNzYWdlKHsKICAgICAgICBjb21tYW5kOiAnb2snCiAgICAgIH0pOwogICAgfSBjYXRjaCAoZSkgewogICAgICBzZWxmLnBvc3RNZXNzYWdlKHsKICAgICAgICBjb21tYW5kOiAnZXJyb3InLAogICAgICAgIG1lc3NhZ2U6IGUubWVzc2FnZQogICAgICB9KTsKICAgIH0KICB9OwogIHZhciBjb3B5VG9YcHUgPSBmdW5jdGlvbiBjb3B5VG9YcHUoZGF0YSkgewogICAgdHJ5IHsKICAgICAgdmFyIG1lbUFkZHJlc3MgPSBkYXRhLm1lbUFkZHJlc3M7CiAgICAgIGlmIChtZW1BbGxvYy5oYXMobWVtQWRkcmVzcykpIHsKICAgICAgICB2YXIgX21lbUFsbG9jJGdldDIgPSBtZW1BbGxvYy5nZXQobWVtQWRkcmVzcyksCiAgICAgICAgICB3b3JrZXJNZW1BZGRyZXNzID0gX21lbUFsbG9jJGdldDIud29ya2VyTWVtQWRkcmVzczsKICAgICAgICB2YXIgbWVtb3J5QnVmZmVyVWludDggPSBuZXcgVWludDhBcnJheShtZW1vcnkuYnVmZmVyKTsKICAgICAgICBtZW1vcnlCdWZmZXJVaW50OC5zZXQoZGF0YS5idWZmZXIsIHdvcmtlck1lbUFkZHJlc3MpOwogICAgICB9CiAgICAgIHNlbGYucG9zdE1lc3NhZ2UoewogICAgICAgIGNvbW1hbmQ6ICdvaycKICAgICAgfSk7CiAgICB9IGNhdGNoIChlKSB7CiAgICAgIHNlbGYucG9zdE1lc3NhZ2UoewogICAgICAgIGNvbW1hbmQ6ICdlcnJvcicsCiAgICAgICAgbWVzc2FnZTogZS5tZXNzYWdlCiAgICAgIH0pOwogICAgfQogIH07CiAgdmFyIGNvcHlGcm9tWHB1ID0gZnVuY3Rpb24gY29weUZyb21YcHUoZGF0YSkgewogICAgdHJ5IHsKICAgICAgdmFyIG1lbUFkZHJlc3MgPSBkYXRhLm1lbUFkZHJlc3MsCiAgICAgICAgc2l6ZSA9IGRhdGEuc2l6ZTsKICAgICAgaWYgKG1lbUFsbG9jLmhhcyhtZW1BZGRyZXNzKSkgewogICAgICAgIHZhciBfbWVtQWxsb2MkZ2V0MyA9IG1lbUFsbG9jLmdldChtZW1BZGRyZXNzKSwKICAgICAgICAgIHdvcmtlck1lbUFkZHJlc3MgPSBfbWVtQWxsb2MkZ2V0My53b3JrZXJNZW1BZGRyZXNzOwogICAgICAgIHZhciBtZW1vcnlCdWZmZXJVaW50OCA9IG5ldyBVaW50OEFycmF5KG1lbW9yeS5idWZmZXIpOwogICAgICAgIHNlbGYucG9zdE1lc3NhZ2UoewogICAgICAgICAgY29tbWFuZDogJ29rJywKICAgICAgICAgIHJlc3VsdDogbWVtb3J5QnVmZmVyVWludDguc2xpY2Uod29ya2VyTWVtQWRkcmVzcywgd29ya2VyTWVtQWRkcmVzcyArIHNpemUpCiAgICAgICAgfSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgc2VsZi5wb3N0TWVzc2FnZSh7CiAgICAgICAgICBjb21tYW5kOiAnb2snLAogICAgICAgICAgcmVzdWx0OiBuZXcgVWludDhBcnJheSgwKQogICAgICAgIH0pOwogICAgICB9CiAgICB9IGNhdGNoIChlKSB7CiAgICAgIHNlbGYucG9zdE1lc3NhZ2UoewogICAgICAgIGNvbW1hbmQ6ICdlcnJvcicsCiAgICAgICAgbWVzc2FnZTogZS5tZXNzYWdlCiAgICAgIH0pOwogICAgfQogIH07CiAgdmFyIHhwdUFjdGlvbk1hcCA9IF9vYmplY3RTcHJlYWQoX2RlZmluZVByb3BlcnR5KF9kZWZpbmVQcm9wZXJ0eShfZGVmaW5lUHJvcGVydHkoX2RlZmluZVByb3BlcnR5KF9kZWZpbmVQcm9wZXJ0eSh7fSwgUHZYcHVBY3Rpb24uSU5JVCwgaW5pdCksIFB2WHB1QWN0aW9uLkFMTE9DLCBhbGxvY01lbSksIFB2WHB1QWN0aW9uLkZSRUUsIGZyZWVNZW0pLCBQdlhwdUFjdGlvbi5DT1BZX1RPX1hQVSwgY29weVRvWHB1KSwgUHZYcHVBY3Rpb24uQ09QWV9GUk9NX1hQVSwgY29weUZyb21YcHUpLCBwdk12bUFjdGlvbk1hcCk7CiAgc2VsZi5vbm1lc3NhZ2UgPSAvKiNfX1BVUkVfXyovZnVuY3Rpb24gKCkgewogICAgdmFyIF9yZWYzID0gX2FzeW5jVG9HZW5lcmF0b3IoIC8qI19fUFVSRV9fKi9fcmVnZW5lcmF0b3JSdW50aW1lLm1hcmsoZnVuY3Rpb24gX2NhbGxlZTMoZXZlbnQpIHsKICAgICAgcmV0dXJuIF9yZWdlbmVyYXRvclJ1bnRpbWUud3JhcChmdW5jdGlvbiBfY2FsbGVlMyQoX2NvbnRleHQzKSB7CiAgICAgICAgd2hpbGUgKDEpIHN3aXRjaCAoX2NvbnRleHQzLnByZXYgPSBfY29udGV4dDMubmV4dCkgewogICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICBpZiAoIShldmVudC5kYXRhLmFjdGlvbiBpbiB4cHVBY3Rpb25NYXApKSB7CiAgICAgICAgICAgICAgX2NvbnRleHQzLm5leHQgPSA2OwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGV2ZW50LmRhdGEuZ2xvYmFscyA9IHsKICAgICAgICAgICAgICBleHBvcnRzOiBleHBvcnRzJDEsCiAgICAgICAgICAgICAgbWVtb3J5OiBtZW1vcnksCiAgICAgICAgICAgICAgbWVtQWxsb2M6IG1lbUFsbG9jCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIF9jb250ZXh0My5uZXh0ID0gNDsKICAgICAgICAgICAgcmV0dXJuIHhwdUFjdGlvbk1hcFtldmVudC5kYXRhLmFjdGlvbl0oZXZlbnQuZGF0YSk7CiAgICAgICAgICBjYXNlIDQ6CiAgICAgICAgICAgIF9jb250ZXh0My5uZXh0ID0gNzsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlIDY6CiAgICAgICAgICAgIHNlbGYucG9zdE1lc3NhZ2UoewogICAgICAgICAgICAgIGNvbW1hbmQ6ICdmYWlsZWQnLAogICAgICAgICAgICAgIG1lc3NhZ2U6ICJVbnJlY29nbml6ZWQgY29tbWFuZDogIi5jb25jYXQoZXZlbnQuZGF0YS5hY3Rpb24pCiAgICAgICAgICAgIH0pOwogICAgICAgICAgY2FzZSA3OgogICAgICAgICAgY2FzZSAiZW5kIjoKICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0My5zdG9wKCk7CiAgICAgICAgfQogICAgICB9LCBfY2FsbGVlMyk7CiAgICB9KSk7CiAgICByZXR1cm4gZnVuY3Rpb24gKF94MykgewogICAgICByZXR1cm4gX3JlZjMuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH07CiAgfSgpOwoKfSkoKTsKCg==",Z=null,m=!1,function(I){return u=u||r(d,Z,m),new Worker(u,I)});function B(I,C){for(var A=0;A<C.length;A++){var e=C[A];e.enumerable=e.enumerable||!1,e.configurable=!0,"value"in e&&(e.writable=!0),Object.defineProperty(I,g(e.key),e)}}function y(I,g){var C="undefined"!=typeof Symbol&&I[Symbol.iterator]||I["@@iterator"];if(!C){if(Array.isArray(I)||(C=function(I,g){if(!I)return;if("string"==typeof I)return G(I,g);var C=Object.prototype.toString.call(I).slice(8,-1);"Object"===C&&I.constructor&&(C=I.constructor.name);if("Map"===C||"Set"===C)return Array.from(I);if("Arguments"===C||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(C))return G(I,g)}(I))||g&&I&&"number"==typeof I.length){C&&(I=C);var A=0,e=function(){};return{s:e,n:function(){return A>=I.length?{done:!0}:{done:!1,value:I[A++]}},e:function(I){throw I},f:e}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var c,i=!0,o=!1;return{s:function(){C=C.call(I)},n:function(){var I=C.next();return i=I.done,I},e:function(I){o=!0,c=I},f:function(){try{i||null==C.return||C.return()}finally{if(o)throw c}}}}function G(I,g){(null==g||g>I.length)&&(g=I.length);for(var C=0,A=new Array(g);C<g;C++)A[C]=I[C];return A}!function(I){I[I.INIT=0]="INIT",I[I.ALLOC=1]="ALLOC",I[I.FREE=2]="FREE",I[I.COPY_TO_XPU=3]="COPY_TO_XPU",I[I.COPY_FROM_XPU=4]="COPY_FROM_XPU",I[I.MATRIX_VECTOR_MULTIPLY=5]="MATRIX_VECTOR_MULTIPLY",I[I.SYNC_VECTOR=6]="SYNC_VECTOR"}(a||(a={}));var H=function(){function I(){!function(I,g){if(!(I instanceof g))throw new TypeError("Cannot call a class as a function")}(this,I)}var g,C,A;return g=I,A=[{key:"addXpu",value:function(g,C){I.xpuObjects.set(g,C)}},{key:"getXpu",value:function(g){return I.xpuObjects.get(g)}},{key:"hasXpu",value:function(g){return I.xpuObjects.has(g)}},{key:"removeXpu",value:function(g){if(I.xpuObjects.has(g)){var C,A=y(I.xpuObjects.get(g).deviceMem);try{for(A.s();!(C=A.n()).done;){var e=C.value;I.memoryObjects.delete(e)}}catch(I){A.e(I)}finally{A.f()}I.xpuObjects.delete(g)}}},{key:"addMemory",value:function(g,C){I.memoryObjects.set(g,C),I.xpuObjects.get(C.objAddress).deviceMem.add(g)}},{key:"getMemory",value:function(g){return I.memoryObjects.get(g)}},{key:"hasMemory",value:function(g){return I.memoryObjects.has(g)}},{key:"removeMemory",value:function(g){I.hasMemory(g)&&I.xpuObjects.get(I.getMemory(g).objAddress).deviceMem.delete(g),I.memoryObjects.delete(g)}}],(C=null)&&B(g.prototype,C),A&&B(g,A),Object.defineProperty(g,"prototype",{writable:!1}),I}();C(H,"xpuObjects",new Map),C(H,"memoryObjects",new Map);var h=function(I,g,C){return I.postMessage(g,C),new Promise((function(g,C){I.onmessage=function(I){switch(I.data.command){case"ok":g(I.data.result);break;case"failed":case"error":C(I.data.message);break;default:C("Unrecognized command: ".concat(I.data.command))}}}))};function V(I,g){var C=Object.keys(I);if(Object.getOwnPropertySymbols){var A=Object.getOwnPropertySymbols(I);g&&(A=A.filter((function(g){return Object.getOwnPropertyDescriptor(I,g).enumerable}))),C.push.apply(C,A)}return C}function X(I,g){var C="undefined"!=typeof Symbol&&I[Symbol.iterator]||I["@@iterator"];if(!C){if(Array.isArray(I)||(C=function(I,g){if(!I)return;if("string"==typeof I)return S(I,g);var C=Object.prototype.toString.call(I).slice(8,-1);"Object"===C&&I.constructor&&(C=I.constructor.name);if("Map"===C||"Set"===C)return Array.from(I);if("Arguments"===C||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(C))return S(I,g)}(I))||g&&I&&"number"==typeof I.length){C&&(I=C);var A=0,e=function(){};return{s:e,n:function(){return A>=I.length?{done:!0}:{done:!1,value:I[A++]}},e:function(I){throw I},f:e}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var c,i=!0,o=!1;return{s:function(){C=C.call(I)},n:function(){var I=C.next();return i=I.done,I},e:function(I){o=!0,c=I},f:function(){try{i||null==C.return||C.return()}finally{if(o)throw c}}}}function S(I,g){(null==g||g>I.length)&&(g=I.length);for(var C=0,A=new Array(g);C<g;C++)A[C]=I[C];return A}var p=function(I,g){var A=function(g,C){new Int32Array(I.buffer)[g/Int32Array.BYTES_PER_ELEMENT]=C},c=function(){var I=e(b.mark((function I(C,e,c){var i,o,t,l;return b.wrap((function(I){for(;;)switch(I.prev=I.next){case 0:if(g){I.next=3;break}return A(c,-1),I.abrupt("return");case 3:i=0===e?8:e,o=[],t=0;case 6:if(!(t<i)){I.next=14;break}return l=new s,o.push(l),I.next=11,h(l,{action:a.INIT,wasm:g});case 11:t++,I.next=6;break;case 14:H.addXpu(C,{deviceMem:new Set,numWorkers:i,workers:o}),A(c,0);case 16:case"end":return I.stop()}}),I)})));return function(g,C,A){return I.apply(this,arguments)}}(),i=function(){var I=e(b.mark((function I(g,C,e,c,i,o){var t,l,n,r,d,Z,m;return b.wrap((function(I){for(;;)switch(I.prev=I.next){case 0:if(t=H.getXpu(g)){I.next=4;break}return A(o,-1),I.abrupt("return");case 4:if(l=0===c?t.numWorkers:c,e%c==0){I.next=9;break}return A(o,-1),console.error("Failed to allocate memory: alloc size ".concat(e," must be divisible by batch ").concat(c,".")),I.abrupt("return");case 9:n=1===i,r=Math.ceil(e/l/t.numWorkers)*l,d=e,Z=[],m=0;case 14:if(!(m<t.numWorkers)){I.next=26;break}if(!n){I.next=19;break}Z.push(h(t.workers[m],{action:a.ALLOC,size:e,memAddress:C})),I.next=23;break;case 19:if(Z.push(h(t.workers[m],{action:a.ALLOC,size:Math.min(d,r),memAddress:C})),!((d-=r)<=0)){I.next=23;break}return I.abrupt("break",26);case 23:m++,I.next=14;break;case 26:return I.next=28,Promise.all(Z);case 28:H.addMemory(C,{objAddress:g,isShared:n,allocSize:e,chunkSize:r}),A(o,0);case 30:case"end":return I.stop()}}),I)})));return function(g,C,A,e,c,i){return I.apply(this,arguments)}}(),o=function(){var I=e(b.mark((function I(g){var C,A,e,c,i;return b.wrap((function(I){for(;;)switch(I.prev=I.next){case 0:if(!H.hasMemory(g)){I.next=8;break}for(C=H.getMemory(g),A=C.objAddress,e=H.getXpu(A),c=[],i=0;i<e.numWorkers;i++)c.push(h(e.workers[i],{action:a.FREE,memAddress:g}));return I.next=7,Promise.all(c);case 7:H.removeMemory(g);case 8:case"end":return I.stop()}}),I)})));return function(g){return I.apply(this,arguments)}}(),t=function(){var g=e(b.mark((function g(C,A,e){var c,i,o,t,l,n,r,d,Z;return b.wrap((function(g){for(;;)switch(g.prev=g.next){case 0:if(c=H.getMemory(C)){g.next=3;break}return g.abrupt("return");case 3:i=c.objAddress,o=c.isShared,t=c.chunkSize,l=H.getXpu(i),n=new Uint8Array(I.buffer).slice(A,A+e),r=[],d=e,Z=0;case 9:if(!(Z<l.numWorkers)){g.next=21;break}if(!o){g.next=14;break}r.push(h(l.workers[Z],{action:a.COPY_TO_XPU,memAddress:C,buffer:n})),g.next=18;break;case 14:if(r.push(h(l.workers[Z],{action:a.COPY_TO_XPU,memAddress:C,buffer:n.slice(Z*t,(Z+1)*t)})),!((d-=t)<=0)){g.next=18;break}return g.abrupt("break",21);case 18:Z++,g.next=9;break;case 21:return g.next=23,Promise.all(r);case 23:case"end":return g.stop()}}),g)})));return function(I,C,A){return g.apply(this,arguments)}}(),l=function(){var g=e(b.mark((function g(C,A,e){var c,i,o,t,l,n,r,d,Z,m,u,s,B,y;return b.wrap((function(g){for(;;)switch(g.prev=g.next){case 0:if(c=H.getMemory(C)){g.next=3;break}return g.abrupt("return");case 3:if(i=c.objAddress,o=c.allocSize,t=c.isShared,l=c.chunkSize,n=H.getXpu(i),r=new Uint8Array(I.buffer),d=[],!t){g.next=11;break}d.push(h(n.workers[0],{action:a.COPY_FROM_XPU,memAddress:C,size:o})),g.next=21;break;case 11:Z=o,m=0;case 13:if(!(m<n.numWorkers)){g.next=21;break}if(d.push(h(n.workers[m],{action:a.COPY_FROM_XPU,memAddress:C,size:Math.min(Z,l)})),0!==(Z-=l)){g.next=18;break}return g.abrupt("break",21);case 18:m++,g.next=13;break;case 21:return g.next=23,Promise.all(d);case 23:u=g.sent,s=0,B=0;case 26:if(!(B<u.length)){g.next=38;break}if(y=u[B],!(s+y.length>e)){g.next=33;break}return r.set(y.slice(0,e-s),A+s),g.abrupt("break",38);case 33:r.set(y,A+s),s+=y.length;case 35:B++,g.next=26;break;case 38:case"end":return g.stop()}}),g)})));return function(I,C,A){return g.apply(this,arguments)}}();return function(I){for(var g=1;g<arguments.length;g++){var A=null!=arguments[g]?arguments[g]:{};g%2?V(Object(A),!0).forEach((function(g){C(I,g,A[g])})):Object.getOwnPropertyDescriptors?Object.defineProperties(I,Object.getOwnPropertyDescriptors(A)):V(Object(A)).forEach((function(g){Object.defineProperty(I,g,Object.getOwnPropertyDescriptor(A,g))}))}return I}({pv_xpu_web_worker_device_init_wasm:c,pv_xpu_web_worker_device_cleanup_wasm:function(I){var g=H.getXpu(I);if(g){var C,A=X(g.workers);try{for(A.s();!(C=A.n()).done;){C.value.terminate()}}catch(I){A.e(I)}finally{A.f()}H.removeXpu(I)}},pv_xpu_web_worker_device_mem_alloc_wasm:i,pv_xpu_web_worker_device_mem_free_wasm:o,pv_xpu_web_worker_device_mem_copy_to_xpu_wasm:t,pv_xpu_web_worker_device_mem_copy_from_xpu_wasm:l},function(I){var g=function(g,C){new Int32Array(I.buffer)[g/Int32Array.BYTES_PER_ELEMENT]=C},C=function(){var I=e(b.mark((function I(C,A,e,c,i,o,t){var l,n,r,d,Z,m,u,s,B,y,G;return b.wrap((function(I){for(;;)switch(I.prev=I.next){case 0:if(l=H.getXpu(C)){I.next=4;break}return g(t,-1),I.abrupt("return");case 4:if(n=H.getMemory(A)){I.next=8;break}return g(t,-1),I.abrupt("return");case 8:r=l.numWorkers,d=n.chunkSize/(i/2),Z=c,m=[],u=0;case 13:if(!(u<r)){I.next=21;break}if(m.push(h(l.workers[u],{action:a.MATRIX_VECTOR_MULTIPLY,matrixAddress:A,vectorAddress:e,m:Math.min(Z,d),n:i,resultAddress:o})),!((Z-=d)<=0)){I.next=18;break}return I.abrupt("break",21);case 18:u++,I.next=13;break;case 21:return s=new Float32Array(i),I.next=24,Promise.all(m);case 24:for(B=I.sent,y=0;y<B.length;y++)B[y].length>0&&s.set(B[y],y*d);for(m=[],G=0;G<r;G++)m.push(h(l.workers[G],{action:a.SYNC_VECTOR,vectorAddress:o,buffer:s}));return I.next=30,Promise.all(m);case 30:case"end":return I.stop()}}),I)})));return function(g,C,A,e,c,i,o){return I.apply(this,arguments)}}();return{pv_matrix_vector_multiply_web_worker_wasm:C}}(I))};export{p as default};
